#!/usr/bin/env bash
set -e

# Required:
# - GITHUB_TOKEN for pushing to maelvls.github.io

if [ -t 1 ]; then
    gray='\033[90m'
    red='\033[91m'
    green='\033[92m'
    yel='\033[93m'
    end='\033[0m'
fi

if [ -z "$GITHUB_TOKEN" ]; then
    echo -e "${red}error:${end} ${yel}GITHUB_TOKEN not set (set it in .envrc and use direnv)${end}" >&2
    exit 1
fi

HUGO_REPO=$PWD

# $1 = current hugo repo. $2 = dir where clone must be made.
function clone_hugo_source() {
    git clone --branch=source -q "$1" "$2" --recurse-submodules | cat
}
function clone_hugo_compiled() {
    git clone --branch=master -q "$1" "$2" --recurse-submodules | cat
}

set +x
echo -en "$gray"

echo -e "${red}2)${end} ${yel}Updating ${green}maelvls.github.io${end}...${end}"
echo -e "    ${green}note:${end} 'master' contains compiled code, 'source' is the actual hugo source"

echo -en "$gray"
set -x
{
    # Current directory is the hugo source files.
    cd "$(mktemp -d)"
    clone_hugo_source "$HUGO_REPO" .
    hugo --quiet

    # COMPILED is the compiled files on the 'master' branch of maelvls.github.io.
    COMPILED=$(mktemp -d)
    clone_hugo_compiled "$HUGO_REPO" "$COMPILED"
    git -C "$COMPILED" reset --hard origin/master
    git -C "$COMPILED" checkout master

    # Copy what Hugo generated (public/) to COMPILED (master branch of maelvls.github.io.)
    cp -R public/* "$COMPILED"
    git -C "$COMPILED" add .
    git -C "$COMPILED" ci -m "update on $(date)" | cat || true
    git -C "$COMPILED" push https://user:${GITHUB_TOKEN}@github.com/maelvls/maelvls.github.io.git master -f -q
}
set +x
echo -en "$end"
