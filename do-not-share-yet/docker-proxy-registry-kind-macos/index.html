<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.64.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="MaÃ«l Valais"><meta name="keywords" content="kubernetes,kind,docker,networking"><meta name="description" content="Kind offers an excellent UX to Kubernetes developers but lacks support for caching images; each time you recreate a new cluster, all the previous downloaded images are gone. In this post, I explain why the default Docker network is a trap and how to set up a registry &amp; make sure that it actually works."><meta property="og:title" content="Pull-through Docker registry on Kind clusters on macOS" />
<meta property="og:description" content="Kind offers an excellent UX to Kubernetes developers but lacks support for caching images; each time you recreate a new cluster, all the previous downloaded images are gone. In this post, I explain why the default Docker network is a trap and how to set up a registry &amp; make sure that it actually works." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/docker-proxy-registry-kind-macos/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/docker-proxy-registry-kind-macos/cover-docker-proxy-registry-kind-macos.png" />
<meta property="article:published_time" content="2020-07-03T15:13:39+02:00" />
<meta property="article:modified_time" content="2020-07-03T15:13:39+02:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/docker-proxy-registry-kind-macos/cover-docker-proxy-registry-kind-macos.png"/>

<meta name="twitter:title" content="Pull-through Docker registry on Kind clusters on macOS"/>
<meta name="twitter:description" content="Kind offers an excellent UX to Kubernetes developers but lacks support for caching images; each time you recreate a new cluster, all the previous downloaded images are gone. In this post, I explain why the default Docker network is a trap and how to set up a registry &amp; make sure that it actually works."/>
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Pull-through Docker registry on Kind clusters on macOS | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">03</span>
<span class="rest">Jul 2020</span>
</div>
</div>

<div class="matter">
<h1 class="title">Pull-through Docker registry on Kind clusters on macOS</h1>
</div>
</div>
<div class="markdown">
<!--
Diagram on macOS + Docker: https://textik.com/#b185c1a72a6e782d
-->
<p><strong>TL;DR:</strong></p>
<ul>
<li>
<p>to create a local pull-through registry to speed up image pulling in a
<a href="https://kind.sigs.k8s.io/">Kind</a> cluster, run:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker run -d --name registry --restart<span class="o">=</span>always --net<span class="o">=</span>kind -e <span class="nv">REGISTRY_PROXY_REMOTEURL</span><span class="o">=</span>https://registry-1.docker.io registry:2
kind create cluster --config /dev/stdin <span class="s">&lt;&lt;EOF
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">containerdConfigPatches:
</span><span class="s">  - |-
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;docker.io&#34;]
</span><span class="s">      endpoint = [&#34;http://registry:5000&#34;]
</span><span class="s">EOF</span>
</code></pre></div></li>
<li>
<p>in case you often create &amp; delete Kind clusters, using a local registry
that serves as a proxy avoids redundant downloads</p>
</li>
<li>
<p><code>KIND_EXPERIMENTAL_DOCKER_NETWORK</code> is useful but remember that the
default network (<code>bridge</code>) doesn&rsquo;t have DNS resolution for container
hostnames</p>
</li>
<li>
<p>the Docker default network (<code>bridge</code>) <a href="https://stackoverflow.com/questions/41400603/dockers-embedded-dns-on-the-default-bridged-network">has
limitations</a>
as <a href="https://docs.docker.com/network/bridge/#use-the-default-bridge-network">detailed by Docker</a>.</p>
</li>
<li>
<p>If you play with <a href="https://cluster-api.sigs.k8s.io/">ClusterAPI</a> with its
<a href="https://github.com/kubernetes-sigs/cluster-api/tree/master/test/infrastructure/docker">Docker provider</a>, you might not be able to use a local
registry due to the clusters being created on the default network, which
means the &ldquo;registry&rdquo; hostname won&rsquo;t be resolved (but we could work around
that).</p>
</li>
</ul>
<hr>
<p><a href="https://kind.sigs.k8s.io/">Kind</a> is an awesome tool that allows you to
spin up local Kubernetes clusters locally in seconds. It is perfect for
Kubernetes developers or anyone who wants to play with controllers.</p>
<p>One thing I hate about Kind is that images are not cached between two Kind
containers. Even worse: when deleting and re-creating a cluster, all the
downloaded images disappear.</p>
<p>And since I install ClusterAPI on my Kind cluster, it means all the (quite
heavy) images have to be re-downloaded every single time. Just take a look
at all the images that get re-downloaded:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># That&#39;s the cluster created using &#39;kind create cluster&#39;</span>
% docker <span class="nb">exec</span> -it kind-control-plane crictl images
IMAGE                                                                      TAG      SIZE
quay.io/jetstack/cert-manager-cainjector                                   v0.11.0  11.1MB
quay.io/jetstack/cert-manager-controller                                   v0.11.0  14MB
quay.io/jetstack/cert-manager-webhook                                      v0.11.0  14.3MB
us.gcr.io/k8s-staging-capi-docker/capd-manager/capd-manager-amd64          dev      53.5MB
us.gcr.io/k8s-artifacts-prod/cluster-api/cluster-api-controller            v0.3.0   20.3MB
us.gcr.io/k8s-artifacts-prod/cluster-api/kubeadm-bootstrap-controller      v0.3.0   19.6MB
us.gcr.io/k8s-artifacts-prod/cluster-api/kubeadm-control-plane-controller  v0.3.0   21.1MB

<span class="c1"># I also use a ClusterAPI-created cluster (relying on CAPD):</span>
% docker <span class="nb">exec</span> -it capd-capd-control-plane-l4tx7 crictl images ls
docker.io/calico/cni                  v3.12.2             8b42391a46731       77.5MB
docker.io/calico/kube-controllers     v3.12.2             5ca01eb356b9a       23.1MB
docker.io/calico/node                 v3.12.2             4d501404ee9fa       89.7MB
docker.io/calico/pod2daemon-flexvol   v3.12.2             2abcc890ae54f       37.5MB
docker.io/metallb/controller          v0.9.3              4715cbeb69289       17.1MB
docker.io/metallb/speaker             v0.9.3              f241be9dae666       19.2MB
</code></pre></div><p>That&rsquo;s a total of 418 MB that get re-downloaded every time I restart both
clusters!</p>
<p>One solution to this problem is to <a href="https://kind.sigs.k8s.io/docs/user/local-registry/">spin up an intermediary Docker
registry</a> in a side
container; as long as this container exists, all the images that have
already been downloaded once can be served from cache. Let&rsquo;s spin up this
registry:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker run -d --net<span class="o">=</span>other --restart<span class="o">=</span>always --name registry registry:2
</code></pre></div><p>Now, let&rsquo;s tell <code>kind</code> that we want the created node to be using this
cache:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kind create cluster --config /dev/stdin <span class="s">&lt;&lt;EOF
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">containerdConfigPatches:
</span><span class="s">  - |-
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;registry&#34;]
</span><span class="s">      endpoint = [&#34;http://registry:5000&#34;]
</span><span class="s">EOF</span>
</code></pre></div><p>And&hellip; it doesn&rsquo;t work! The first thing to notice is that the registry runs
on the default network (named <a href="https://docs.docker.com/network/bridge/#use-the-default-bridge-network"><code>bridge</code></a>) but my cluster
was created with a separate network (named <code>kind</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker inspect registry --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
bridge 172.17.0.2

% docker inspect kind-control-plane --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
kind 172.18.0.2

% docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
a6ceea984c68        bridge              bridge              <span class="nb">local</span>
6f6a9618d746        host                host                <span class="nb">local</span>
4927dc2eba9b        kind                bridge              <span class="nb">local</span>
</code></pre></div><p>My first attempt was to move the kind cluster to the default network (why
does it use another network anyway??) and kind has an experimental option
for that:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% <span class="nv">KIND_EXPERIMENTAL_DOCKER_NETWORK</span><span class="o">=</span>bridge kind create cluster --config /dev/stdin <span class="s">&lt;&lt;EOF
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">containerdConfigPatches:
</span><span class="s">  - |-
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;registry&#34;]
</span><span class="s">      endpoint = [&#34;http://registry:5000&#34;]
</span><span class="s">EOF</span>

Creating cluster <span class="s2">&#34;kind&#34;</span> ...
WARNING: Overriding docker network due to KIND_EXPERIMENTAL_DOCKER_NETWORK
WARNING: Here be dragons! This is not supported currently.
 â Ensuring node image <span class="o">(</span>kindest/node:v1.18.2<span class="o">)</span> ð¼
 â Preparing nodes ð¦
 â Writing configuration ð
 â Starting control-plane ð¹ï¸
 â Installing CNI ð
 â Installing StorageClass ð¾
Set kubectl context to <span class="s2">&#34;kind-kind&#34;</span>
</code></pre></div><p>Perfect! My local cluster is now on the same network as my tiny registry
cache:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker inspect registry --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
bridge 172.17.0.2

% docker inspect kind-control-plane --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
bridge 172.17.0.6
</code></pre></div><p>But&hellip; it doesn&rsquo;t seem to work&hellip; The registry is still empty, no cached
blobs:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker <span class="nb">exec</span> -it registry ls /var/lib/registry
<span class="c1"># Nothing!</span>
</code></pre></div><p>After digging a bit more, I realized that Kind had chosen to create it own
network due to the fact that the default &ldquo;bridge&rdquo; has limitations and
<a href="https://docs.docker.com/config/containers/container-networking/#dns-services">doesn&rsquo;t allow you</a> to use container names as DNS names:</p>
<blockquote>
<p>By default, a container inherits the DNS settings of the host, as defined
in the <code>/etc/resolv.conf</code> configuration file. Containers that use the
default bridge network get a copy of this file, whereas containers that
use a custom network use Dockerâs embedded DNS server, which forwards
external DNS lookups to the DNS servers configured on the host.</p>
</blockquote>
<p>Let&rsquo;s try to reproduce this issue. I first run a registry with the default
network, and I then try to connect to it from a second container using the
hostname <code>registry</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker run -d --rm --name registry registry:2
% docker run -it --rm alpine nslookup registry
Server:         127.0.0.11
Address:        127.0.0.11:53
Non-authoritative answer:
Name:   registry
Address: 172.18.0.7

<span class="c1"># Let&#39;s cleanup:</span>
% docker <span class="nb">kill</span> registry
</code></pre></div><p>Now, let&rsquo;s do the same but a custom network named &ldquo;other&rdquo; instead of the
default network:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker network create other
% docker run -d --rm --net<span class="o">=</span>other --name registry registry:2
% docker run -it --rm --net<span class="o">=</span>other alpine nslookup registry
Server:         127.0.0.11
Address:        127.0.0.11:53
Non-authoritative answer:
Name:   registry
Address: 172.18.0.7

<span class="c1"># Let&#39;s cleanup:</span>
% docker <span class="nb">kill</span> registry
</code></pre></div><p>I thought I could first start the container on the default network and then
move the containers to the &ldquo;other&rdquo; network (so that DNS with container
names works) but it does not seem to work either:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker run -d --rm --name registry registry:2
% docker run -d --rm --name alpine alpine sleep 1d

% docker network create other
% docker network disconnect bridge registry
% docker network disconnect bridge alpine
% docker network connect other registry
% docker network connect other alpine

<span class="c1"># Now, let&#39;s see if &#39;alpine&#39; can resolve &#39;registry&#39;:</span>
% docker <span class="nb">exec</span> -it alpine nslookup registry
</code></pre></div><p>I also tried to understand the difference between containers with the
default network and containers with the &ldquo;other&rdquo; network. As stated <a href="https://docs.docker.com/config/containers/container-networking/#dns-services">in the
Docker documentation</a>, a container created on the default
network is setup slightly differently.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 1ï¸â£ With default network:</span>
% docker run -it --rm alpine cat /etc/resolv.conf
<span class="c1"># This file is included on the metadata iso</span>
nameserver 192.168.65.1

% docker run -it --rm alpine cat /etc/hosts
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.4      8f4a5e6bad39

<span class="c1"># 2ï¸â£ With the &#39;other&#39; network:</span>
% docker run -it --rm --net<span class="o">=</span>other alpine cat /etc/resolv.conf
nameserver 127.0.0.11
options ndots:0

% docker run -it --rm --net<span class="o">=</span>other alpine cat /etc/hosts
127.0.0.1       localhost
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.19.0.4      fed220ca6bd0
</code></pre></div><p>So it definitely comes from <code>/etc/resolv.conf</code>! With the default network,
the <code>/etc/resolv.conf</code> that gets set up does not allow you to resolve
container names.</p>
<p>So in order to use container names as hostnames, I have to create your own
using <code>docker network create</code>.</p>
<p>Let&rsquo;s re-created my registry on the &ldquo;kind&rdquo; network and also re-create the
cluster without the <code>KIND_EXPERIMENTAL_DOCKER_NETWORK=bridge</code> option:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker network create kind
docker run -d --name registry --restart<span class="o">=</span>always --net<span class="o">=</span>kind registry:2
kind create cluster --config /dev/stdin <span class="s">&lt;&lt;EOF
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">containerdConfigPatches:
</span><span class="s">  - |-
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;registry&#34;]
</span><span class="s">      endpoint = [&#34;http://registry:5000&#34;]
</span><span class="s">EOF</span>
</code></pre></div><p>Both are now on the same subnet:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker inspect registry --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
kind 172.18.0.2

% docker inspect kind-control-plane --format <span class="s1">&#39;{{range $net, $cfg := .NetworkSettings.Networks}}{{$net}} {{$cfg.IPAddress}}{{end}}&#39;</span>
kind 172.18.0.3
</code></pre></div><p>But creating a simple deployment doesn&rsquo;t seem to work! By looking at the
registry logs, we see no activity at all. Let&rsquo;s see what <code>containerd</code> is up
to:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">% docker exec -i kind-control-plane journalctl -u containerd | grep &#39;registry:5000&#39;
containerd[129]: Start cri plugin with config {Registry:{Mirrors:map[
  docker.io: {Endpoints:[https://registry-1.docker.io]}
  registry:  {Endpoints:[http://registry:5000]}
]}}
</code></pre></div><blockquote>
<p>â I had to remove <code>-t</code> (tty) from the above command. That&rsquo;s because
<code>journalctl</code> was using a pager because this terminal was TTY (which means
it had /dev/stdin open? not sure). To disable the pager I removed <code>-t</code>.</p>
</blockquote>
<p>I guess contained picks the first mirror (<code>docker.io</code>); so let&rsquo;s override
the <code>docker.io</code> key:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker rm -f registry
docker run -d --name registry --restart<span class="o">=</span>always --net<span class="o">=</span>kind registry:2
kind create cluster --config /dev/stdin <span class="s">&lt;&lt;EOF
</span><span class="s">kind: Cluster
</span><span class="s">apiVersion: kind.x-k8s.io/v1alpha4
</span><span class="s">containerdConfigPatches:
</span><span class="s">  - |-
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.registry.mirrors.&#34;docker.io&#34;]
</span><span class="s">      endpoint = [&#34;http://registry:5000&#34;]
</span><span class="s">EOF</span>
</code></pre></div><p>And here is the actual configuration given to containerd:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker <span class="nb">exec</span> -it kind-control-plane cat /etc/containerd/config.toml
<span class="nv">version</span> <span class="o">=</span> <span class="m">2</span>
<span class="o">[</span>plugins<span class="o">]</span>
  <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="o">]</span>
    <span class="nv">sandbox_image</span> <span class="o">=</span> <span class="s2">&#34;k8s.gcr.io/pause:3.2&#34;</span>
    <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd<span class="o">]</span>
      <span class="nv">default_runtime_name</span> <span class="o">=</span> <span class="s2">&#34;runc&#34;</span>
      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes<span class="o">]</span>
        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span class="o">]</span>
          <span class="nv">runtime_type</span> <span class="o">=</span> <span class="s2">&#34;io.containerd.runc.v2&#34;</span>
        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.test-handler<span class="o">]</span>
          <span class="nv">runtime_type</span> <span class="o">=</span> <span class="s2">&#34;io.containerd.runc.v2&#34;</span>
    <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class="o">]</span>
      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class="o">]</span>
registry<span class="s2">&#34;]
</span><span class="s2">          endpoint = [&#34;</span>http://registry:5000<span class="s2">&#34;</span><span class="s2">]
</span></code></pre></div><p>We can see the registry serving images by creating a deployment:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% kubectl create deployment <span class="nb">test</span> --image alpine
% docker logs registry <span class="p">|</span> tail
172.18.0.3 - - <span class="o">[</span>03/Jul/2020:12:18:21 +0000<span class="o">]</span> <span class="s2">&#34;HEAD /v2/library/alpine/manifests/latest HTTP/1.1&#34;</span> <span class="m">404</span> <span class="m">96</span> <span class="s2">&#34;&#34;</span> <span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span>
172.18.0.3 - - <span class="o">[</span>03/Jul/2020:12:18:50 +0000<span class="o">]</span> <span class="s2">&#34;HEAD /v2/library/alpine/manifests/latest HTTP/1.1&#34;</span> <span class="m">404</span> <span class="m">96</span> <span class="s2">&#34;&#34;</span> <span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span>
172.18.0.3 - - <span class="o">[</span>03/Jul/2020:12:19:40 +0000<span class="o">]</span> <span class="s2">&#34;HEAD /v2/library/alpine/manifests/latest HTTP/1.1&#34;</span> <span class="m">404</span> <span class="m">96</span> <span class="s2">&#34;&#34;</span> <span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span>
</code></pre></div><p>Nope, not yet&hellip; All the GET requests are answered with a <code>404 Not Found</code>.
It&rsquo;s probably because I forgot to enable <a href="https://docs.docker.com/registry/configuration/#proxy">the pull-through
feature</a> which turns
the registry into an &ldquo;image proxy&rdquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">docker rm -f registry
docker run -d --name registry --restart<span class="o">=</span>always --net<span class="o">=</span>kind -e <span class="nv">REGISTRY_PROXY_REMOTEURL</span><span class="o">=</span>https://registry-1.docker.io registry:2
</code></pre></div><p>And&hellip; It works!!</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% docker logs registry <span class="p">|</span> tail
172.18.0.3 - - <span class="o">[</span>03/Jul/2020:12:51:24 +0000<span class="o">]</span> <span class="s2">&#34;HEAD /v2/library/alpine/manifests/latest HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">1638</span> <span class="s2">&#34;&#34;</span> <span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span>
<span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2020-07-03T12:51:38.728711481Z&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;response completed&#34;</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">&#34;registry:5000&#34;</span> http.request.id<span class="o">=</span>89341304-f38b-4ce3-9364-429709311783 http.request.method<span class="o">=</span>HEAD http.request.remoteaddr<span class="o">=</span><span class="s2">&#34;172.18.0.3:54188&#34;</span> http.request.uri<span class="o">=</span><span class="s2">&#34;/v2/library/alpine/manifests/latest&#34;</span> http.request.useragent<span class="o">=</span><span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span> http.response.contenttype<span class="o">=</span><span class="s2">&#34;application/vnd.docker.distribution.manifest.list.v2+json&#34;</span> http.response.duration<span class="o">=</span>271.043848ms http.response.status<span class="o">=</span><span class="m">200</span> http.response.written<span class="o">=</span><span class="m">1638</span>
172.18.0.3 - - <span class="o">[</span>03/Jul/2020:12:51:38 +0000<span class="o">]</span> <span class="s2">&#34;HEAD /v2/library/alpine/manifests/latest HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">1638</span> <span class="s2">&#34;&#34;</span> <span class="s2">&#34;containerd/v1.3.3-14-g449e9269&#34;</span>
</code></pre></div><blockquote>
<p>Note: the <a href="https://docs.docker.com/registry/configuration/#proxy">Docker
docs</a> indicates
YAML fields; to pass the same configuration as env variables, you can use
<code>REGISTRY_</code> and then the path to the field you want. For example,</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">proxy</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">  </span><span class="k">remoteurl</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//registry<span class="m">-1.</span>docker.io<span class="w">
</span></code></pre></div><p>becomes</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nv">REGISTRY_PROXY_REMOTEURL</span><span class="o">=</span>https://registry-1.docker.io
</code></pre></div></blockquote>
<h2 id="improving-the-clusterapi-docker-provider-to-use-a-given-network">Improving the ClusterAPI docker provider to use a given network</h2>
<p>When I play with ClusterAPI, I usually use the CAPD provider (ClusterAPI
Provider Docker). This provider <a href="https://github.com/kubernetes-sigs/cluster-api/blob/master/test/infrastructure/docker">is kept
in-tree</a>
inside the cluster-api projet.</p>
<p>I want to use the caching mechanism presented above. But to do that, I need
to make sure the clusters created by CAPD are not created on the default
network (<a href="https://sigs.k8s.io/cluster-api/test/infrastructure/docker/docker/kind_manager.go#L178">current
implementation</a>
creates CAPD clusters on the default &ldquo;bridge&rdquo; network).</p>
<p>I want to be able to customize the network on which the CAPD provider
creates the container that make up the cluster. Imagine that we could pass
the network name as part of a
<a href="https://github.com/kubernetes-sigs/cluster-api/blob/6821939410c37743b45c36ec91d94c37dba1998e/test/e2e/data/infrastructure-docker/cluster-template.yaml#L26-L35">DockerMachineTemplate</a>
(the content of the <code>spec</code> is defined in code
<a href="https://github.com/kubernetes-sigs/cluster-api/blob/2ac3728d26593f7c54520999477aad45934e1c59/test/infrastructure/docker/api/v1alpha3/dockermachine_types.go#L30-L55">here</a>):</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>infrastructure.cluster.x-k8s.io/v1alpha3<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>DockerMachineTemplate<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>capd-control-plane<span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">      </span><span class="k">extraMounts</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="w">        </span>- <span class="k">containerPath</span><span class="p">:</span><span class="w"> </span>/var/run/docker.sock<span class="w">
</span><span class="w">          </span><span class="k">hostPath</span><span class="p">:</span><span class="w"> </span>/var/run/docker.sock<span class="w">
</span><span class="w">
</span><span class="w">      </span><span class="k">network</span><span class="p">:</span><span class="w"> </span>kind<span class="w">        </span><span class="c"># ð° This field does not exist yet.</span><span class="w">
</span></code></pre></div>
</div>
<a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/docker-proxy-registry-kind-macos/index.md">ð Edit this page and propose a change!</a>
<div class="tags">










<div style="float: right;">
<p>Tags:



























<a href="/tags/docker/"> docker </a>





























<a href="/tags/kind/"> kind </a>









<a href="/tags/kubernetes/"> kubernetes </a>

























<a href="/tags/networking/"> networking </a>





































</div>
<div class="clearit"></div>





</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="ð¬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
