<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.64.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="keywords" content="networking,gcp"><meta name="description" content="In one of my previous posts, I studied how traffic flows when using
Kubernetes Services. While drawing the last diagram, I did not clearly
see how traffic could make its way back to the user. In this
post, I focus on how packets find their way back and what makes stateless
rewriting interesting.
"><meta property="og:title" content="How do packets find their way back?" />
<meta property="og:description" content="In one of my previous posts, I studied how traffic flows when using
Kubernetes Services. While drawing the last diagram, I did not clearly
see how traffic could make its way back to the user. In this
post, I focus on how packets find their way back and what makes stateless
rewriting interesting.
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/how-do-packets-come-back/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/how-do-packets-come-back/cover-how-can-packets-come-back.png" />
<meta property="article:published_time" content="2020-04-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/how-do-packets-come-back/cover-how-can-packets-come-back.png"/>

<meta name="twitter:title" content="How do packets find their way back?"/>
<meta name="twitter:description" content="In one of my previous posts, I studied how traffic flows when using
Kubernetes Services. While drawing the last diagram, I did not clearly
see how traffic could make its way back to the user. In this
post, I focus on how packets find their way back and what makes stateless
rewriting interesting.
"/>

  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>How do packets find their way back? | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">13</span>
<span class="rest">Apr 2020</span>
</div>
</div>

<div class="matter">
<h1 class="title">How do packets find their way back?</h1>
</div>
</div>
<div class="markdown">
<p>In a previous post &ldquo;<a href="/packets-eye-kubernetes-service/">The Packet&rsquo;s-Eye View of a Kubernetes
Service</a>&quot;, I studied how traffic flows in when
using Kubernetes Services. In the last diagram of that post, I could not
clearly see how traffic could make its way back to the user. In this
article, I will try to understand how packets are able to flow back to the
user and where stateless rewriting happens.</p>
<p>In the following diagram, we can see a packet coming from a user, then
being re-written by Google&rsquo;s VPC firewalls and finally coming into a VM
&ldquo;node 1&rdquo;.</p>
<p><img alt="Packet coming from a user hitting one going through Google's VPC"
src="dnat-google-vpc-how-comes-back.svg" width="80%"/></p>
<p>So, how come the packet can come back <del>and does it use conntrack</del> and
does Google&rsquo;s firewall have to remember some state?</p>
<blockquote>
<p><strong>Update 14th April:</strong> I initially thought that the conntrack kernel
module would not register anything when using DNAT.
<a href="https://twitter.com/networkop1">@networkop1</a> showed me that conntrack
registers the connection even for stateless DNATing.</p>
</blockquote>
<blockquote>
<p><a href="https://netfilter.org/documentation/HOWTO/netfilter-hacking-HOWTO-3.html#ss3.3">conntrack</a>
is a part of the netfilter suite in the Linux kernel. It is in charge of
remembering connections that are forwarded. The initial packet hits the
iptables machinery and conntrack remembers it so that further packets
don&rsquo;t need to go through iptables again. You can list the tracked
connections using the
<a href="https://manpages.debian.org/testing/conntrack/conntrack.8.en.html">conntrack(8)</a>
tool. I mention it in &ldquo;<a href="/debugging-kubernetes-networking">Debugging Kubernetes
Networking</a>&quot;.</p>
</blockquote>
<p>Let us dive a bit more and add the &ldquo;response&rdquo; packets. For the following
diagram, I used the excellent <a href="https://textik.com/">textik</a> ascii drawing
tool.</p>
<div class="nohighlight">
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">                     D-NAT (dest-based NAT, also called port-forwarding)

          +--------------------------------------------------------------------------+
          |   src: 90.76.45.149:32345                       src: 35.211.248.124:80   |
          |   dst: 35.211.248.124:80                        dst: 90.76.45.149:32345  |
          +------------------------------90.76.45.149--------------------------------+
                         |                 (user)                     |
                         |                                            |
          +--------------------------------------------------------------------------+
          |              |                one-to-one                  |              |
          |              v              port forwarding               |              |
          |   src: 90.76.45.149:32345          =          - src: 10.142.0.62:80      |
          | - dst: 35.211.248.124:80      no need for     + src: 35.211.248.124:80   |
          | + dst: 10.142.0.62:80         conntrack to      dst: 90.76.45.149:32345  |
          |              |                 remember!                  ^              |
          |              |                (stateless)                 |              |
          |              |                                            |              |
          +--------------|--------------35.211.248.124----------------|--------------+
                         |              (Google&#39;s VPC)                |
                         |                                            |
                         |                                            |
          +--------------|--------------------------------------------|--------------+
          |              v             userland process               |              |
          |   src: 90.76.45.149:32345      response         src: 10.142.0.62:80      |
          |   dst: 10.142.0.62:80      ----------------&gt;    dst: 90.76.45.149:32345  |
          |                                                                          |
          +-------------------------------10.142.0.62--------------------------------+
                                          (VM in VPC)
</code></pre></div></div>
<!-- https://textik.com/#0db10960397c06f5 -->
<p>By reading through the diagram, we can see that the packet is re-written by
Google&rsquo;s firewall using DNAT: the destination is replaced by a fixed IP,
the one of the VM.</p>
<blockquote>
<p>Why do I say &ldquo;packets&rdquo; but what I should really say is &ldquo;segments&rdquo;? That&rsquo;s
because I don&rsquo;t really know anyone using this strict terminology. Outside
of the kernel and TCP/IP stack implementors, who actually cares about the
L3 layer &ldquo;units&rdquo;? And I enjoy the &ldquo;packet&rdquo; word too more than &ldquo;segment&rdquo;!</p>
</blockquote>
<p>Now, why do I care about Google&rsquo;s firewalls storing state? That&rsquo;s because
if some state about a connection has to be remembered, it means it is
harder to distribute the firewall horizontally, which makes it harder to
scale.</p>
<p>As we can see on the diagram, the firewall does not need to remember
anything: it is just a static one-to-one relation between <code>10.142.0.62</code> and
<code>35.211.248.124</code>.</p>
<hr>
<p>Here is what I want to remember from this post:</p>
<ol>
<li>
<p>Outgoing traffic from your broadband modem router has to be SNATed
(source-based NAT). The router needs to keep track of outgoing
connections using conntrack.</p>
</li>
<li>
<p>Incoming traffic from the Internet to a Google Cloud VM has to go
through the VPC firewall. The packet rewriting is very fast and very
scalable since it only uses DNAT, which means no need to remember
anything.</p>
</li>
<li>
<p>Most packet forwarding in Kubernetes relies on stateless DNATing (e.g.
<code>hostPort</code> or <code>nodePort</code>). Some parts of Kubernetes rely on stateful
SNAT rewriting, for example when you use <code>externalTrafficPolicy: Cluster</code> in a which is the default policy for a Service. The following
diagram shows where this rewriting happens (extracted from the last
diagram in &ldquo;<a href="/packets-eye-kubernetes-service/">The Packet&rsquo;s-Eye View of a Kubernetes
Service</a>&quot;):</p>
<img alt="Packet's source is rewritten (SNAT) because of the 'policy: Cluster' that is set in the Service." src="kubernetes-snat-cluster-ip.svg" width="50%"/>
</li>
</ol>

</div>
<div class="tags">









<div class="taxosfloating_left">
<p>Tags</p>
</div>
<div class="termsfloating_right">
<p>











<a href="/tags/gcp/"> gcp </a>





































<a href="/tags/networking/"> networking </a>





















</div>
<div class="clearit"></div>





</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="ðŸ’¬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
