<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.64.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta property="og:title" content="The Client-go Transitive Hell" />
<meta property="og:description" content="‚ö†Ô∏è I&rsquo;m not sure this is a transitive issue. It might just not be due to transitivity at all!
 Looks like the Kubernetes people chose to break the client-go API without bumping the major version (with a new import path e.g k8s.io/client-go/v13) when adding support for context.Context that comes with Kubernetes v1.18. Darren Shepherd reported the issue in February 2020. We were warned:
 The v0.x.y tags indicate that go APIs may change in incompatible ways in different versions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/client-go-transitive-hell/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/title/cover.png" />
<meta property="article:published_time" content="2020-04-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-04-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/title/cover.png"/>

<meta name="twitter:title" content="The Client-go Transitive Hell"/>
<meta name="twitter:description" content="‚ö†Ô∏è I&rsquo;m not sure this is a transitive issue. It might just not be due to transitivity at all!
 Looks like the Kubernetes people chose to break the client-go API without bumping the major version (with a new import path e.g k8s.io/client-go/v13) when adding support for context.Context that comes with Kubernetes v1.18. Darren Shepherd reported the issue in February 2020. We were warned:
 The v0.x.y tags indicate that go APIs may change in incompatible ways in different versions."/>

  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>The Client-go Transitive Hell | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">15</span>
<span class="rest">Apr 2020</span>
</div>
</div>

<div class="matter">
<h1 class="title">The Client-go Transitive Hell</h1>
</div>
</div>
<div class="markdown">
<blockquote>
<p>‚ö†Ô∏è I&rsquo;m not sure this is a transitive issue. It might just not be due to
transitivity at all!</p>
</blockquote>
<p>Looks like the Kubernetes people chose to break the client-go API without
bumping the major version (with a new import path e.g
<code>k8s.io/client-go/v13</code>) when adding support for <code>context.Context</code> that
comes with Kubernetes v1.18. Darren Shepherd reported the
<a href="issues.k8s.io/88472">issue</a> in February 2020. We <a href="https://github.com/kubernetes/client-go#compatibility-your-code---client-go">were warned</a>:</p>
<blockquote>
<p>The v0.x.y tags indicate that go APIs may change in incompatible ways in
different versions.</p>
</blockquote>
<p>At first, I thought that it would not affect us at Ori since we don‚Äôt use
any extra dependency that rely on client-go ‚Äî so no transitive dependencies
on client-go, we are the sole user of it. We then began working on some
tooling depending on the API of our main project. And the transitive hell
began.</p>
<p>Here is what the error looks like:</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain"># k8s.io/client-go/rest
../../../go/pkg/mod/k8s.io/client-go@v11.0.0+incompatible/rest/request.go:598:31: not enough arguments in call to watch.NewStreamWatcher
        have (*versioned.Decoder)
        want (watch.Decoder, watch.Reporter)
</code></pre></div><p>On top of that, you might also have a version mismatch between <code>k8s.io/api</code>
and <code>k8s.io/apimachinery</code> with the following error:</p>
<div class="highlight"><pre class="chroma"><code class="language-plain" data-lang="plain">../../../go/pkg/mod/k8s.io/client-go@v11.0.0+incompatible/tools/clientcmd/api/v1/conversion.go:52:12: s.DefaultConvert undefined (type conversion.Scope has no field or method DefaultConvert)
</code></pre></div><p>The workaround is to set client-go to use the latest pre-v1.18 version:</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff"> require (
<span class="gd">-    k8s.io/client-go v11.0.0+incompatible
</span><span class="gd"></span><span class="gd">-    k8s.io/apimachinery v0.18.1
</span><span class="gd"></span><span class="gd">-    k8s.io/api v0.18.1 //indirect
</span><span class="gd"></span><span class="gi">+    k8s.io/client-go v0.0.0-20190918160344-1fbdaa4c8d90
</span><span class="gi"></span><span class="gi">+    k8s.io/apimachinery v0.17.4
</span><span class="gi"></span><span class="gi">+    k8s.io/api v0.17.4 //indirect
</span><span class="gi"></span> )
</code></pre></div><p>The <code>v0.17.4</code> version is the last version of apimachinery and api that
stays compatible with client-go pre-v1.18.</p>
<p><strong>Long-term</strong>: you want to move away from client-go <code>v11.0.0</code> (i.e. tag
<code>kubernetes-1.14.0</code>) to an earlier version (e.g. <code>v12.0.0</code>).</p>
<p>What‚Äôs funny is that we can‚Äôt use <code>v12.0.0</code> because the client-go project
doesn&rsquo;t follow the &ldquo;<a href="https://research.swtch.com/vgo-import">semantic import
versioning</a>&rdquo; rule so you can‚Äôt just
do</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% go get k8s.io/client-go@v12.0.0
go get k8s.io/client-go@v12.0.0: k8s.io/client-go@v12.0.0: invalid version: module contains a go.mod file, so major version must be compatible: should be v0 or v1, not v12
</code></pre></div><p>Client-go also maintains another set of tags that begin with <code>v0.*</code> (e.g.,
<code>v0.18.0</code>) for that specific reason. Just a clever way of escaping the
semantic import versioning, but all these different versions make it very
confusing&hellip;</p>
<p>And when you use the <code>kubernetes-1.17.4</code> tag, it redirects to the <code>v0.17.4</code>
tag (my guess is that it is infered by <code>go get</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% go get k8s.io/client-go@kubernetes-1.17.4
go: k8s.io/client-go kubernetes-1.17.4 <span class="o">=</span>&gt; v0.17.4
go: downloading k8s.io/client-go v0.17.4
</code></pre></div><p>And to make even more confusing, these tags (kubernetes-v1.17.4, v0.17.4
and v12.0.0) are not set on the master branch; instead, they all live on
headless branches.</p>
<p>This issue is a reminder that we (Kubernetes hackers who write controllers
for a living) heavily rely on the ‚Äúgood will‚Äù of the Kubernetes team. These
decisions as they might affect anyone relying on Kubernetes &ldquo;as a
platform&rdquo;&hellip; ü§î</p>
<!--
https://ori-edge.slack.com/archives/C96DU1WDC/p1583851517147600?thread_ts=1582966579.027200&cid=C96DU1WDC
https://ori-edge.slack.com/archives/C96DU1WDC/p1586525068128100
--><blockquote>
</blockquote>

</div>
<div class="tags">









</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="üí¨"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
