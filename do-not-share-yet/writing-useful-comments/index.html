<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.147.6">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="keywords" content="go,software-engineering"><meta name="description" content="We often talk about avoiding unnecessary comments that needlessly paraphrase what the code does. In this article, I gathered some thoughts about why writing comments is as important as writing the code itself, and how to spot comments that should be refactored using the &#39;what&#39; and the &#39;why&#39;."><meta property="og:url" content="https://maelvls.dev/do-not-share-yet/writing-useful-comments/">
  <meta property="og:site_name" content="maelvls dev blog">
  <meta property="og:title" content="Writing useful comments">
  <meta property="og:description" content="We often talk about avoiding unnecessary comments that needlessly paraphrase what the code does. In this article, I gathered some thoughts about why writing comments is as important as writing the code itself, and how to spot comments that should be refactored using the &#39;what&#39; and the &#39;why&#39;.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="2020">
    <meta property="article:published_time" content="2021-06-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-06-05T00:00:00+00:00">
    <meta property="article:tag" content="Go">
    <meta property="article:tag" content="Software-Engineering">
    <meta property="og:image" content="https://maelvls.dev/do-not-share-yet/writing-useful-comments/cover-writing-useful-comments.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/writing-useful-comments/cover-writing-useful-comments.png">
  <meta name="twitter:title" content="Writing useful comments">
  <meta name="twitter:description" content="We often talk about avoiding unnecessary comments that needlessly paraphrase what the code does. In this article, I gathered some thoughts about why writing comments is as important as writing the code itself, and how to spot comments that should be refactored using the &#39;what&#39; and the &#39;why&#39;.">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Writing useful comments | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://x.com/maelvls"><i title="X" class="icons fab fa-x"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">05</span>
                <span class="rest">
                    
                    Jun2021
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">Writing useful comments</h1>
        </div>
        
        <span style="font-size: xx-small; text-align: right">
            cross-post <a href="https://dev.to/maelvls/you-should-write-comments-36fd">
                <i title="Maël Valais's DEV Community Profile" class="icons fab fa-dev"></i>
            </a>
        </span>
        
    </div>
    <div class="markdown">
        <p>In his book <em><a href="https://www.oreilly.com/library/view/clean-code-a/9780136083238/">Clean Code</a></em>, Robert C. Martin makes a strong case against comments:</p>
<blockquote>
<p>You don&rsquo;t need comments if you write clean code.</p></blockquote>
<p>Like any blanket statement, Martin is partially true. Although code clarity increases readability and decreases the need for comments, code has never been able to convey the whole context to the reader.</p>
<p>Programming patterns are often cited as a way to convey this context on a codebase scale. Well named functions and variables also convey some form of context. But most of the time, the context (the &ldquo;why&rdquo;) never gets written anywhere.</p>
<p>In this article, I present a few examples meant to showcase how comments may be written to convey the context around code.</p>
<p><strong>Contents:</strong></p>
<ol>
<li><a href="#code-example-1">Code example 1</a></li>
<li><a href="#code-example-2">Code example 2</a></li>
<li><a href="#code-example-3">Code example 3</a></li>
<li><a href="#code-example-4">Code example 4</a></li>
<li><a href="#shaping-comments">Shaping comments</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ol>
<h2 id="code-example-1">Code example 1</h2>
<p>I call &ldquo;in-flight comments&rdquo; comments that we write to ease the process of writing code. In-flight comments help us articulate what we are trying to achieve.</p>
<p>In the following example taken from the <a href="https://developers.google.com/tech-writing/two/code-comments">Google&rsquo;s Technical Writing</a>, the developer wrote a comment as they were writing an algorithm for randomly shuffling a slice of integers:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Shuffle</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">curIndex</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If the current index is 0, return directly.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">curIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This comment is a typical in-flight comment: it only focuses on what the code does. This comment does not give context as to why this <code>if</code> statement exists. We can refactor this comment by focusing on the &ldquo;why&rdquo;:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Shuffle</span><span class="p">(</span><span class="nx">slice</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">curIndex</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">slice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// No need to shuffle an array with zero elements.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">curIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The reader now understand why this <code>if</code> exists, and does not have to dig further. Starting with the &ldquo;why&rdquo; helps glanceability: the reader only needs to read the first few words to get the idea.</p>
<p>Here is how I would diffenciate the &ldquo;why&rdquo; from the &ldquo;what&rdquo;:</p>
<table>
  <thead>
      <tr>
          <th>Content in a comment</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>The &ldquo;why&rdquo;</td>
          <td>Helps you understand how this piece of code came to life.</td>
      </tr>
      <tr>
          <td>The &ldquo;what&rdquo;</td>
          <td>Paraphrases* what is being done in a human-readable format.</td>
      </tr>
  </tbody>
</table>
<p>*Sometimes, the &ldquo;what&rdquo; may be valuable for readability purposes. I see three reasons to comment on the &ldquo;what&rdquo;:</p>
<ol>
<li>When the code is not self-explanatory, a &ldquo;what&rdquo; comment may avoid the reader the struggle of googling;</li>
<li>When a block of code is lenghy, adding &ldquo;what&rdquo; comments may help create &ldquo;sections&rdquo;, helping the reader quicly find the part they are interested in.</li>
</ol>
<h2 id="code-example-2">Code example 2</h2>
<p>Our next example comes from the cert-manager codebase:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// If the certificate request has been denied, set the last failure time to</span>
</span></span><span class="line"><span class="cl"><span class="c1">// now, and set the Issuing status condition to False with reason. We only</span>
</span></span><span class="line"><span class="cl"><span class="c1">// perform this check if the request also doesn&#39;t have a Ready condition,</span>
</span></span><span class="line"><span class="cl"><span class="c1">// since some issuers may not honor a Denied condition, and will sign and</span>
</span></span><span class="line"><span class="cl"><span class="c1">// set the Ready condition to True anyway. We would still want to complete</span>
</span></span><span class="line"><span class="cl"><span class="c1">// issuance for requests where the issuer doesn&#39;t respect approval.</span>
</span></span><span class="line"><span class="cl"><span class="nx">cond</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">GetCertificateRequestCondition</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequestConditionReady</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">cond</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">CertificateRequestIsDenied</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">failIssueCertificate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">crt</span><span class="p">,</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">GetCertificateRequestCondition</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequestConditionDenied</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After looking at the <code>if</code> statement, the reader wonders: why do we need this <code>if</code> statement?</p>
<p>Their first reaction will probably be to take a look at the comment right above. Unfortunately, the comment starts with even more confusing implementation details. The reader has to keep reading until the 6th line to find out why the code is doing what it is doing.</p>
<p>Let us rate each individual information that the comment conveys:</p>
<table>
  <thead>
      <tr>
          <th>Paragraph</th>
          <th>Usefulness</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>(A)</strong> If the certificate request has been denied, set the last failure time to now, and set the Issuing status condition to False with reason.</td>
          <td>⭐</td>
      </tr>
      <tr>
          <td><strong>(B)</strong> We only perform this check if the request also doesn&rsquo;t have a Ready condition.</td>
          <td>⭐⭐</td>
      </tr>
      <tr>
          <td><strong>(C)</strong> Some issuers may not honor a Denied condition, and will sign and set the Ready condition to True anyway.</td>
          <td>⭐⭐⭐</td>
      </tr>
      <tr>
          <td><strong>(D)</strong> We would still want to complete issuance for requests where the issuer doesn&rsquo;t respect approval.</td>
          <td>⭐⭐⭐⭐</td>
      </tr>
  </tbody>
</table>
<p>From the reader&rsquo;s perspective, the paragraphs (D) and (C) are the most useful. They give a high-level overview of why this <code>if</code> statement exists. We can merge the two paragraphs into one:</p>
<blockquote>
<p><strong>(C, D)</strong> External issuers may ignore the approval API. An issuer ignores the approval API when it proceeds with the issuance even though the &ldquo;Denied=True&rdquo; condition is present on the CertificateRequest. To avoid breaking the issuers that are ignoring the approval API, we want to detect when CertificateRequests has ignored the Denied=True condition; when it is the case, we skip bubbling-up the (possible) Denied condition.</p></blockquote>
<p>Paragraphs (B) and (A) may also be useful: they give the context about paragraph (C). The sentence lacks precision though, and &ldquo;this check&rdquo; may confuse the reader. Let us rephrase it:</p>
<blockquote>
<p><strong>(A, B)</strong> To know when the Denied=True condition was ignored by the issuer, we look at the CertificateRequest&rsquo;s Ready condition. If both the Ready and Denied</p></blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Some issuers won&#39;t honor the &#34;Denied=True&#34; condition, and we don&#39;t want</span>
</span></span><span class="line"><span class="cl"><span class="c1">// to break these issuers. To avoid breaking these issuers, we skip bubbling</span>
</span></span><span class="line"><span class="cl"><span class="c1">// up the &#34;Denied=True&#34; condition from the certificate request object to the</span>
</span></span><span class="line"><span class="cl"><span class="c1">// certificate object when the issuer ignores the &#34;Denied&#34; state.</span>
</span></span><span class="line"><span class="cl"><span class="c1">//</span>
</span></span><span class="line"><span class="cl"><span class="c1">// To know whether or not an issuer ignores the &#34;Denied&#34; state, we pay</span>
</span></span><span class="line"><span class="cl"><span class="c1">// attention to the &#34;Ready&#34; condition on the certificate request. If a</span>
</span></span><span class="line"><span class="cl"><span class="c1">// certificate request is &#34;Denied=True&#34; and that the issuer still proceeds</span>
</span></span><span class="line"><span class="cl"><span class="c1">// to adding the &#34;Ready&#34; condition (to either true or false), then we</span>
</span></span><span class="line"><span class="cl"><span class="c1">// consider that this issuer has ignored the &#34;Denied&#34; state.</span>
</span></span><span class="line"><span class="cl"><span class="nx">cond</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">GetCertificateRequestCondition</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequestConditionReady</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">cond</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">CertificateRequestIsDenied</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">failIssueCertificate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">crt</span><span class="p">,</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">GetCertificateRequestCondition</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequestConditionDenied</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="code-example-3">Code example 3</h2>
<p>Another example <a href="https://github.com/jetstack/cert-manager/blob/1dad685e/pkg/controller/ingress-shim/sync.go#L145">inspired</a> by the cert-manager codebase:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">errs</span> <span class="o">:=</span> <span class="nf">validateIngressTLSBlock</span><span class="p">(</span><span class="nx">tls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// if this tls entry is invalid, record an error event on Ingress object and continue to the next tls entry</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rec</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">ingress</span><span class="p">,</span> <span class="s">&#34;Warning&#34;</span><span class="p">,</span> <span class="s">&#34;BadConfig&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;TLS entry %d is invalid: %s&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">errs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">continue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Once again, the in-flight comment can be rewritten to focus on the &ldquo;why&rdquo;:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Let the user know that an TLS entry has been skipped due to being invalid.</span>
</span></span><span class="line"><span class="cl"><span class="nx">errs</span> <span class="o">:=</span> <span class="nf">validateIngressTLSBlock</span><span class="p">(</span><span class="nx">tls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rec</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">ingress</span><span class="p">,</span> <span class="s">&#34;Warning&#34;</span><span class="p">,</span> <span class="s">&#34;BadConfig&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;TLS entry %d is invalid: %s&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">errs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">continue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="code-example-4">Code example 4</h2>
<p>The next example <a href="https://github.com/jetstack/cert-manager/blob/1dad685e4/pkg/controller/ingress-shim/sync.go#L180-L209">is inspired</a> by an other place in cert-manager.</p>
<p>This is another example of in-flight comment focusing on the &ldquo;what&rdquo;. The context around this block of code is not obvious, which means this comment should refactored to focus on the &ldquo;why&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// check if a Certificate for this secret name exists, and if it</span>
</span></span><span class="line"><span class="cl"><span class="c1">// does then skip this secret name.</span>
</span></span><span class="line"><span class="cl"><span class="nx">expectedCrt</span> <span class="o">:=</span> <span class="nf">expectedCrt</span><span class="p">(</span><span class="nx">ingress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">existingCrt</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Certificates</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ingress</span><span class="p">.</span><span class="nx">secretName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">existingCrt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nf">certMatchesUpdate</span><span class="p">(</span><span class="nx">existingCrt</span><span class="p">,</span> <span class="nx">crt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">toBeUpdated</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">toBeUpdated</span><span class="p">,</span> <span class="nf">updateToMatchExpected</span><span class="p">(</span><span class="nx">expectedCrt</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">toBeCreated</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">toBeCreated</span><span class="p">,</span> <span class="nx">crt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In this case, the code itself would benefit from a bit of refactoring. Regarding the comment, we start with the &ldquo;why&rdquo;:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The secretName has an associated Certificate that has the same name. We want</span>
</span></span><span class="line"><span class="cl"><span class="c1">// to make sure that this Certificate exists and that it matches the expected</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Certificate spec.</span>
</span></span><span class="line"><span class="cl"><span class="nx">existingCrt</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Certificates</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">secretName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">expectedCrt</span> <span class="o">:=</span> <span class="nf">expectedCrt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">existingCrt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">toBeCreated</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">toBeCreated</span><span class="p">,</span> <span class="nx">expectedCrt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">continue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nf">certMatchesExpected</span><span class="p">(</span><span class="nx">existingCrt</span><span class="p">,</span> <span class="nx">expectedCrt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">continue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">toBeUpdated</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">toBeUpdated</span><span class="p">,</span> <span class="nf">updateToMatchExpected</span><span class="p">(</span><span class="nx">expectedCrt</span><span class="p">))</span>
</span></span></code></pre></div><p>Note that we removed the <code>else</code> statement for the purpose of readability. The happy path is now clearly &ldquo;updating the certificate&rdquo;.</p>
<h2 id="shaping-comments">Shaping comments</h2>
<p>To help with readability, I suggest hard-wrapping comments at 80 characters. Above 80 characters, the comments will become hard to read in PR suggestion comments. Take this example comment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// To reduce the memory footprint of the controller-manager,</span>
</span></span><span class="line"><span class="cl"><span class="c1">// we do not cache Secrets.</span>
</span></span><span class="line"><span class="cl"><span class="c1">// We only cache the metadata of Secrets</span>
</span></span><span class="line"><span class="cl"><span class="c1">// which is enough to allow the EnqueueRequestsFromMapFunc to lookup the associated Issuer or ClusterIssuer.</span>
</span></span><span class="line"><span class="cl"><span class="c1">// In NewManager we also use the option ClientDisableCache</span>
</span></span><span class="line"><span class="cl"><span class="c1">// to configure the client to not cache Secrets</span>
</span></span><span class="line"><span class="cl"><span class="c1">// when the token manager Gets and Lists them.</span>
</span></span></code></pre></div><p>Each sentence is started on a new line. This sort of style is fine in a Markdown document where these soft breaks are rendered as a single paragraph.</p>
<p>The problem with the &ldquo;random&rdquo; length of each line is that the reader has to do more work while parsing the text. It is also less aesthetic than a well-wrapped 80 characters comment. Rewrapping the above comment at 80 chars looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// To reduce the memory footprint of the controller-manager, we do not</span>
</span></span><span class="line"><span class="cl"><span class="c1">// cache Secrets. We only cache the metadata of Secrets which is enough to</span>
</span></span><span class="line"><span class="cl"><span class="c1">// allow the EnqueueRequestsFromMapFunc to lookup the associated Issuer or</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ClusterIssuer. In NewManager we also use the option ClientDisableCache</span>
</span></span><span class="line"><span class="cl"><span class="c1">// to configure the client to not cache Secrets when the token manager Gets</span>
</span></span><span class="line"><span class="cl"><span class="c1">// and Lists them.</span>
</span></span></code></pre></div><p>You can obtain the re-wrapping by using the <code>qq</code> command on Vim, or the <a href="https://github.com/stkb/Rewrap">Rewrap</a> extension on VSCode.</p>
<p>If you still want to do separate paragraphs, I&rsquo;d recommend separating each paragraph with two new line breaks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// To reduce the memory footprint of the controller-manager, we do not</span>
</span></span><span class="line"><span class="cl"><span class="c1">// cache Secrets. We only cache the metadata of Secrets which is enough to</span>
</span></span><span class="line"><span class="cl"><span class="c1">// allow the EnqueueRequestsFromMapFunc to lookup the associated Issuer or</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ClusterIssuer.</span>
</span></span><span class="line"><span class="cl"><span class="c1">//</span>
</span></span><span class="line"><span class="cl"><span class="c1">// We use this option along with ClientDisableCache in NewManager to</span>
</span></span><span class="line"><span class="cl"><span class="c1">// configure the client to not cache Secrets when the token manager Gets</span>
</span></span><span class="line"><span class="cl"><span class="c1">// and Lists them.</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>As a developer, I want to write code that is readable and maintainable, and keeping track of the &ldquo;why&rdquo; (i.e., the context) in a codebase is essential for readability and maintainability. I found that putting myself in the place of the future reader helps me write comments that focus on the &ldquo;why&rdquo;.</p>
<p>HAProxy, Git or the Linux kernel are great examples of projects where there is a great focus on well-documented code:</p>
<ul>
<li><a href="https://github.com/haproxy/haproxy/blob/530408f976e5fe2f2f2b4b733b39da36770b566f/ebtree/ebtree.h#L23"><code>ebtree/ebtree.h</code></a> (HAProxy)</li>
<li><a href="https://github.com/git/git/blob/2d2118b814c11f509e1aa76cb07110f7231668dc/unpack-trees.c#L821-L836"><code>unpack-trees.c</code></a> (Git)</li>
<li><a href="https://github.com/torvalds/linux/blob/bfdc6d91a25f4545bcd1b12e3219af4838142ef1/kernel/sched/core.c#L157-L171"><code>kernel/sched/core.c</code></a> (Linux kernel).</li>
</ul>
<!--

## Discussion

Bill Kennedy [shared](https://changelog.com/gotime/172) the importance of making a concious effort towards having a common set of values that help a team write good software. Like anything, the team probably needs to find their own set of values, but the two values that Bill talked about in the Gotime episode seem valuable to me:

1. Be precise. Letting uncertainty and inprecision creep into variable names, function names and package mames greatly decreases the chance for someone to understand the concepts captured by your code.
2. Don’t make things easy to do; instead, make things easy to understand. That's an other
3. Early use of abstractions and other sorts of indirection hurt.

In my mind, being precise also applies to comments. Precision in comments avoid the reader having to wonder "is that what they really meant?". I think that the values and ideas contained in a design philosophy not only apply to code, but also to comments.

### Good naming takes time

Finding a good name that properly carries the exact intent and help self-documenting takes time. It always takes a few iterations before the code becomes self-documenting enough to be able to remove comments.

![Number of comments lowers with time](chart-comments-over-time.svg)

As shown by the diagram, the amount of comments for a given codebase decreases thanks to PR reviews and refactorings. The more we learn and understand our codebase, the better we become at self-documenting.

### Comments are disposable, don't copy them over

Now, let's talk about the issue of comments becoming outdated. Over time, comments start lying. That's where my second point comes into play: deleting and rewriting comments is part of our job. I would even say that it takes around 40% of my time spent coding.

During code reviews, I pay extra attention to these comments. And yes, very often, comments don't make sense anymore because of some copy-paste of code. We must delete any copy-pasted comment and rewrite it. Spreading copy-pasted comments that we don't really know why they were added in the first place is a plague.

## Conclusion

As a final word, I want us to remember that yes, maintaining comments is a pain. Comments will eventually start lying if you don't delete and rewrite them. But would you rather have no comments at all and let the amount of tribal knowledge creep in every part of your codebase, making it harder and harder for new engineers to join the team?

-->
<!--
Join the discussion on Twitter:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I know I know comments always end up outdated and so on. But I really think we should still write beautiful comments! 😇<a href="https://t.co/704lUCDzo2">https://t.co/704lUCDzo2</a></p>&mdash; Maël Valais (@maelvls) <a href="https://twitter.com/maelvls/status/1233140530017644544?ref_src=twsrc%5Etfw">February 27, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


\-->
<p>Updates:</p>
<ul>
<li><strong>24 Feb 2022</strong>: add the section &ldquo;Shaping comments&rdquo;.</li>
</ul>

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/you-should-write-comments/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
        
        <div style="float: right;">
            <p>Tags:
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/go/"> go </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/software-engineering/"> software-engineering </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
        </div>
        <div class="clearit"></div>
        
        
        
        
        
    </div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>
    
</footer></body>
</html>
