<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.147.6">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="keywords" content="Synology,NAS,Single Sign-On,Google,OIDC"><meta name="description" content="Learn how to simplify access to your Synology NAS by enabling single sign-on (SSO) with personal Google accounts."><meta property="og:url" content="https://maelvls.dev/do-not-share-yet/synology-sso-with-personal-google-account/">
  <meta property="og:site_name" content="maelvls dev blog">
  <meta property="og:title" content="Logging into Synology NAS with Personal Google Accounts">
  <meta property="og:description" content="Learn how to simplify access to your Synology NAS by enabling single sign-on (SSO) with personal Google accounts.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="2024">
    <meta property="article:published_time" content="2024-04-17T19:50:33+02:00">
    <meta property="article:modified_time" content="2024-04-17T19:50:33+02:00">
    <meta property="article:tag" content="Synology">
    <meta property="article:tag" content="NAS">
    <meta property="article:tag" content="Single Sign-On">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="OIDC">
    <meta property="og:image" content="https://maelvls.dev/do-not-share-yet/synology-sso-with-personal-google-account/cover-synology-sso-with-personal-google-account.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/synology-sso-with-personal-google-account/cover-synology-sso-with-personal-google-account.png">
  <meta name="twitter:title" content="Logging into Synology NAS with Personal Google Accounts">
  <meta name="twitter:description" content="Learn how to simplify access to your Synology NAS by enabling single sign-on (SSO) with personal Google accounts.">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Logging into Synology NAS with Personal Google Accounts | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://x.com/maelvls"><i title="X" class="icons fab fa-x"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">17</span>
                <span class="rest">
                    
                    Apr2024
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">Logging into Synology NAS with Personal Google Accounts</h1>
        </div>
        
    </div>
    <div class="markdown">
        <h2 id="introduction">Introduction</h2>
<p>My parents and I share a DS923+. We mainly use it for storing photos. To save energy, the NAS is stopped at night and restarted in the morning. Restarting the NAS means that you need to log in to the UI at least once every day.</p>
<p>And since my parents don&rsquo;t use the Synology often, they would first struggle remembering what the username thing is about. And then, they would forget about their password, which would lead to me having to reset it because Synology hasn&rsquo;t implemented a way to reset the password over email:</p>
<p><img src="syno-login-username-1.jpeg" alt="Synology login screen where you are asked for your username but don&rsquo;t remember it"></p>
<p><img src="syno-login-username-2.jpeg" alt="Synology login screen where you are asked to enter your password after having entered your username"></p>
<p>Over the past two years, my parents forgot their passwords a couple of times. It led me to look for an alternative way to log into the NAS&hellip; why not use their Google accounts using the single sign-on mechanism?</p>
<h2 id="challenges-with-local-accounts-and-sso">Challenges with Local Accounts and SSO</h2>
<p>A couple of years ago, Synology introduced SSO (single sign-on). Since 7.2, DSM supports generic OIDC providers, and supports logging into local users (it used to be only possible for LDAP users).</p>
<p>Since my parents are always signed in into their Google account, I figured it would be possible to use OIDC with Google&hellip; Except it won&rsquo;t work with local accounts.</p>
<p>Here is what I tried: I created a My OIDC configuration for Google looked like this:</p>
<p><img src="credentials-page-in-api-and-services-gcp-console.png" alt="Credentials page in API and Services in GCP&rsquo;s Console"></p>
<p>Then, I configured my Synology to use Google&rsquo;s OIDC endpoint:</p>
<p><img src="config-sso-client-using-google-oidc.png" alt="Configuration of the SSO Client using Google OIDC in DSM"></p>
<p>The problem arose with the &ldquo;Username claim&rdquo;. I want to log into my local account <code>mael.valais</code>, but none of the claims in Google&rsquo;s ID tokens contain that username. Here is an example of a Google ID token:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://accounts.google.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;1234987819200.apps.googleusercontent.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;10769150350006150715113082367&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;jsmith@example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email_verified&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1353601026</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1353604926</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="forking-dex-to-use-it-as-an-oidc-middleware-for-google-oidc">Forking Dex to use it as an OIDC middleware for Google OIDC</h2>
<p>I figured I could use Dex to act as a middleware between Synology&rsquo;s OIDC client and Google&rsquo;s OIDC server. My goal was to &ldquo;augment&rdquo; Google&rsquo;s JWTs with Synology&rsquo;s usernames by looking up the user by email.</p>
<p>Dex isn&rsquo;t as flexible as I would have hoped. To make it work, I had to fork it to change the internals of the Google OIDC connector.</p>
<p>Fork: <a href="https://github.com/maelvls/dex/tree/google-to-synology-sso">https://github.com/maelvls/dex/tree/google-to-synology-sso</a></p>
<p>This fork is a fork of the fork presented in <a href="https://github.com/dexidp/dex/pull/2954">https://github.com/dexidp/dex/pull/2954</a>. It builds on the idea of the <code>ExtendPayload</code> interface, which I slightly adjusted to pass the original claims since I needed access to the email contained in the JWT provided by Google.</p>
<p>With this fork, you will need to set three more environment variables:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">SYNO_PASSWD</span><span class="o">=</span>redacted
</span></span><span class="line"><span class="cl"><span class="nv">SYNO_USER</span><span class="o">=</span>mael.valais
</span></span><span class="line"><span class="cl"><span class="nv">SYNO_URL</span><span class="o">=</span>http://127.0.0.1:5000
</span></span></code></pre></div><p>When the OIDC flow with Google is done and before Dex issues its own JWT, I added some code to add the claim <code>username</code>. With this modified Dex, the JWT looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;at_hash&#34;</span><span class="p">:</span> <span class="s2">&#34;-j6HZYvzDaqkQB2KxIgSyw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;caddy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;c_hash&#34;</span><span class="p">:</span> <span class="s2">&#34;8SK3tobDYgaI3cnDzkmi5g&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;mael65@gmail.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;email_verified&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1713387587</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1713301187</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://login.mysynodomain.dev/dex&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Maël Valais&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;nonce&#34;</span><span class="p">:</span> <span class="s2">&#34;MFZFSkESL1XqdQmbvr0T43Kn7v0CzLap&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;ChUxMDAzNjk3OTQzNjg3MDAwOTk5MTISBmdvb2dsZQ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;mael.valais&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here is the updated configuration in DSM:</p>
<p><img src="./config-sso-client-with-dex-in-dsm.png" alt="Configuration of the SSO Client using Dex in DSM"></p>
<h2 id="using-the-fork-of-dex">Using the fork of Dex</h2>
<p>Create a file <code>dex.yaml</code> on your NAS:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="l">https://login.mysynodomain.dev/dex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">sqlite3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l">dex.sqlite</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">http</span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">5556</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logger</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">oauth2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">skipApprovalScreen</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">alwaysShowLoginScreen</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">staticClients</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">synology</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Synology&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">redirectURIs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s1">&#39;https://mysynodomain.dev/&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w"> </span><span class="c"># Use openssl rand -hex 16 to generate this.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">connectors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">google</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">google</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Google</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="l">https://accounts.google.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">clientID</span><span class="p">:</span><span class="w"> </span><span class="l">$GOOGLE_CLIENT_ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">clientSecret</span><span class="p">:</span><span class="w"> </span><span class="l">$GOOGLE_CLIENT_SECRET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">redirectURI</span><span class="p">:</span><span class="w"> </span><span class="l">https://login.mysynodomain.dev/dex/callback</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># I have disabled email login.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">enablePasswordDB</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></div><p>Finally, run Dex:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run --name dex -d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -v <span class="nv">$HOME</span>/dex.yaml:/dex.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -v <span class="nv">$HOME</span>/dex.sqlite:/dex.sqlite <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">SYNO_PASSWD</span><span class="o">=</span>redacted <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">SYNO_USER</span><span class="o">=</span>mael.valais <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">SYNO_URL</span><span class="o">=</span>http://127.0.0.1:5000 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">GOOGLE_CLIENT_ID</span><span class="o">=</span>207842732284-l7nhetlsvimmds80fa2knir8fundp3h4.apps.googleusercontent.com <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -e <span class="nv">GOOGLE_CLIENT_SECRET</span><span class="o">=</span>redacted <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 5556:5556 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ghcr.io/maelvls/dex:google-to-synology-sso-v2@sha256:252713d98c8369612994fbbed6f257d79dc35ff84b2cbb6952a11d63c57b64bb serve /dex.yaml
</span></span></code></pre></div><blockquote>
<p>With this command, you will be using Dex images that I built:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">ghcr.io/maelvls/dex
</span></span></code></pre></div><p>I wouldn&rsquo;t recommend using random Docker images from the internet, especially since this is about authentication. I might be a malicious actor trying to steal your Synology credentials! But if you still want to proceed, here is an image! Note that I am not monitoring the image for security vulnerabilities, and do not guarantee that it is secure. Use at your own risk!</p></blockquote>
<h2 id="the-docker-image">The Docker image</h2>
<p>The Docker image is available on GitHub Container Registry: <a href="https://ghcr.io/maelvls/dex">https://ghcr.io/maelvls/dex</a>.</p>
<h3 id="rebuilding-the-image-yourself-and-pushing-it-to-your-synology-nas">Rebuilding the image yourself and pushing it to your Synology NAS</h3>
<p>First, install <code>zig</code> and <code>ko</code>. That will allow you to cross-compile Dex to <code>linux/amd64</code> on macOS without Buildx (cross-compiling is required because Dex&rsquo;s sqlite library needs CGO)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install ko zig
</span></span></code></pre></div><p>Clone the fork:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/maelvls/dex --branch google-to-synology-sso
</span></span></code></pre></div><p>Then, build the image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">CC</span><span class="o">=</span><span class="s2">&#34;zig cc -target x86_64-linux&#34;</span> <span class="nv">CXX</span><span class="o">=</span><span class="s2">&#34;zig c++ -target x86_64-linux&#34;</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">KO_DOCKER_REPO</span><span class="o">=</span>ghcr.io/maelvls/dex <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">KO_DEFAULTBASEIMAGE</span><span class="o">=</span>alpine <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ko build ./cmd/dex --bare --tarball /tmp/out.tar --push<span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></div><p>Then, copy the image to your NAS:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh yournas /usr/local/bin/docker load &lt;/tmp/out.tar
</span></span></code></pre></div><h3 id="just-so-that-i-dont-forget-here-is-how-i-pushed-ghcriomaelvlsdex-to-github-container-registry">(Just so that I don&rsquo;t forget) Here is how I pushed <code>ghcr.io/maelvls/dex</code> to GitHub Container Registry</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git tag google-to-synology-sso-v1
</span></span><span class="line"><span class="cl">git push maelvls google-to-synology-sso-v1
</span></span></code></pre></div><p>Then, I built and pushed the image with <code>ko</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">CC</span><span class="o">=</span><span class="s2">&#34;zig cc -target x86_64-linux&#34;</span> <span class="nv">CXX</span><span class="o">=</span><span class="s2">&#34;zig c++ -target x86_64-linux&#34;</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">KO_DOCKER_REPO</span><span class="o">=</span>ghcr.io/maelvls/dex <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">KO_DEFAULTBASEIMAGE</span><span class="o">=</span>alpine <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  ko build ./cmd/dex --bare --push<span class="o">=</span><span class="nb">true</span> --tags google-to-synology-sso-v1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --image-annotation <span class="s2">&#34;org.opencontainers.image.description=Google to Synology SSO&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --image-annotation <span class="s2">&#34;org.opencontainers.image.source=https://github.com/maelvls/dex&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --image-annotation <span class="s2">&#34;org.opencontainers.image.revision=</span><span class="k">$(</span>git rev-parse HEAD<span class="k">)</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --image-annotation <span class="s2">&#34;org.opencontainers.image.documentation=https://maelvls.dev/synology-sso-with-personal-google-account/&#34;</span>
</span></span></code></pre></div><p>See the history below to know the image hashes.</p>
<h3 id="history">History</h3>
<h4 id="june-14th-2025-v4">June 14th, 2025: v4</h4>
<p>The dex container kept crashing due to i/o timeouts when Dex was trying to connect to the Synology API. I fixed that by adding a retry mechanism with an exponential backoff and a maximum of 10 retries and maximum of 1 hour between retries.</p>
<p>The image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">ghcr.io/maelvls/dex:google-to-synology-sso-v4@sha256:f8bf15901c2b994337994c4f60c48c154437af656cbe85701cb8d1d7d94127ba
</span></span></code></pre></div><h4 id="apr-12nd-2024-v1">Apr 12nd, 2024: v1</h4>
<p>I pushed the <code>google-to-synology-sso-v1</code> tag with the image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">ghcr.io/maelvls/dex:google-to-synology-sso-v1@sha256:345c8fec6b222c308759f21864c6af3b16c373801fd5e0b7ad4b131a743d3b07
</span></span></code></pre></div><h4 id="june-1st-2025">June 1st, 2025</h4>
<p>The <code>google-to-synology-sso-v1</code> tag was buggy, the <code>ExtendPayload</code> func wasn&rsquo;t being called correctly. I&rsquo;ve pushed <code>google-to-synology-sso-v2</code> to fix that. Here is the new image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">ghcr.io/maelvls/dex:google-to-synology-sso-v2@sha256:252713d98c8369612994fbbed6f257d79dc35ff84b2cbb6952a11d63c57b64bb
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>With this method, my parents can log into the NAS with their Google account and no longer have to remember their Synology username and password.</p>
<p>Although it works, I wish I didn&rsquo;t have to fork Dex to customize the claims it puts into the JWT payload. I came across a couple of designs that would aim to make Dex more extendable, but none have been implemented yet.</p>
<p>The login flow is much smoother now: click &ldquo;Login with Google&rdquo;, select the Google account, and you&rsquo;re in! Just two screens:</p>
<p><img src="syno-login-sso-google-account-1.jpeg" alt="Synology login screen that shows a button that says Login with Google">
<img src="syno-login-sso-google-account-2.png" alt="Google screen allowing you to select a Google account"></p>

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2024/synology-sso-with-personal-google-account/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
        
        <div style="float: right;">
            <p>Tags:
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/google/"> google </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/nas/"> nas </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/oidc/"> oidc </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/single%20sign-on/"> single sign-on </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/synology/"> synology </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
        </div>
        <div class="clearit"></div>
        
        
        
        
        
    </div>
    

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>
    
</footer></body>
</html>
