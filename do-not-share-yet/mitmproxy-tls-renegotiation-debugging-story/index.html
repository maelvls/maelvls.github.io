<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.75.1" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="keywords" content="mitmproxy,tls,debugging,wireshark"><meta name="description" content="I often use mitmproxy in order to see the HTTP calls that programs are making under the hood. vcert, a tool used for operating Venafi TPP and Venafi Cloud, did not seem to be working with mitmproxy. This post presents the steps I took to discover that the issue comes from an unsupported feature of mitmproxy: TLS renegotiation."><meta property="og:title" content="mitmproxy hangs on TLS renegotiation: a debugging story" />
<meta property="og:description" content="I often use mitmproxy in order to see the HTTP calls that programs are making under the hood. vcert, a tool used for operating Venafi TPP and Venafi Cloud, did not seem to be working with mitmproxy. This post presents the steps I took to discover that the issue comes from an unsupported feature of mitmproxy: TLS renegotiation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/mitmproxy-tls-renegotiation-debugging-story/" />
<meta property="og:image" content="https://maelvls.dev/mitmproxy-tls-renegotiation-debugging-story/vcert-with-mitmproxy-decrypted.png" />
<meta property="article:published_time" content="2021-09-25T10:31:19+02:00" />
<meta property="article:modified_time" content="2021-09-25T10:31:19+02:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/mitmproxy-tls-renegotiation-debugging-story/vcert-with-mitmproxy-decrypted.png"/>

<meta name="twitter:title" content="mitmproxy hangs on TLS renegotiation: a debugging story"/>
<meta name="twitter:description" content="I often use mitmproxy in order to see the HTTP calls that programs are making under the hood. vcert, a tool used for operating Venafi TPP and Venafi Cloud, did not seem to be working with mitmproxy. This post presents the steps I took to discover that the issue comes from an unsupported feature of mitmproxy: TLS renegotiation."/>
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>mitmproxy hangs on TLS renegotiation: a debugging story | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">25</span>
                <span class="rest">
                    
                    Sep2021
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">mitmproxy hangs on TLS renegotiation: a debugging story</h1>
        </div>
        
    </div>
    <div class="markdown">
        <p>I frequently use mitmproxy to inspect what HTTP requests and responses look like under the hood. Inspecting HTTP flows comes in handy with tools that tend to hide the actual JSON error messages.</p>
<p>One tool I have been using a lot is <a href="https://github.com/Venafi/vcert"><code>vcert</code></a>. <code>vcert</code> allows you to request X.509 certificates from Venafi Trust Protection Platform (TTP) as well as Venafi Cloud.</p>
<p>In the following example, I give an unknown client ID <code>duh</code>. <code>vcert</code> just tells me about the error in the initial HTTP header:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ vcert getcred --username foo --password bar --client-id<span class="o">=</span>duh --verbose
vCert: 2021/09/19 19:23:56 Getting credentials...
vCert: 2021/09/19 19:23:56 Got <span class="m">400</span> Bad Request status <span class="k">for</span> POST https://venafi-tpp.platform-ops.jetstack.net/vedauth/authorize/oauth
vCert: 2021/09/19 19:24:05 unexpected status code on TPP Authorize. Status: <span class="m">400</span> Bad Request
</code></pre></div><p>I am sure that the HTTP API is returning more than just the HTTP header <code>400 Bad Request</code>!</p>
<p>But when I try using mitmproxy, I get the following error:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">$ HTTPS_PROXY=:9090 vcert getcred --username foo --password bar --client-id=duh --verbose
vCert: 2021/09/19 19:29:20 Getting credentials...
vCert: 2021/09/19 19:29:50 Post &#34;https://venafi-tpp.platform-ops.jetstack.net/vedauth/authorize/oauth&#34;: context deadline exceeded (Client.Timeout exceeded while awaiting headers)
</code></pre></div><p><img src="vcert-hanging.png" alt=""></p>
<p>Looking at the &ldquo;Detail&rdquo; tab for the HTTP call recorded in mitmproxy, I can see that the HTTP request was acknowledged by the TPP server (see the &ldquo;Request complete&rdquo; time). For some reason, the response never arrives.</p>
<p><img src="mitmproxy-request-received.png" alt=""></p>
<p>Let us dig a bit deeper and see what is the difference between &ldquo;with&rdquo; and &ldquo;without&rdquo; mitmproxy using <a href="https://www.wireshark.org/">WireShark</a>. Without mitmproxy, <code>vcert</code> succeeds:</p>
<p><img src="vcert-without-mitmproxy-encrypted.png" alt=""></p>
<p>But with mitmproxy, <code>vcert</code> hangs:</p>
<p><img src="vcert-with-mitmproxy-encrypted.png" alt=""></p>
<p>The difference between both flows seems to be the &ldquo;Encrypted Handshake Message&rdquo; that occurs right after the HTTP requests has been sent.</p>
<blockquote>
<p>Note that you can see the above two PCAP traces by downloading <a href="vcert-with-and-without-mitmproxy-through-iap.pcapng">vcert-with-and-without-mitmproxy-through-iap.pcapng</a>.</p>
</blockquote>
<p>Now, let us decrypt this TLS flow. WireShark being a passive capture tool (unlike mitmproxy), it won&rsquo;t be able to decrypt traffic. Fortunately, mitmproxy is able to dump the master secret (see the page <a href="https://docs.mitmproxy.org/stable/howto-wireshark-tls/">Wireshark and SSL/TLS Master Secrets</a>. After giving the master secret to WireShark, we can see the decrypted traffic:</p>
<p><img src="vcert-with-mitmproxy-decrypted.png" alt=""></p>
<p>The above screenshot validates the fact that the &ldquo;Application Data&rdquo; that we could see in the previous two screenshots was in fact the HTTP request.</p>
<p>We also notice that the mysterious &ldquo;Encrypted Handshake Message&rdquo; is a Hello Request, signifying a TLS renegotiation as described in <a href="https://datatracker.ietf.org/doc/html/rfc5246#section-7.4.1.1">RFC 5246</a>.</p>
<blockquote>
<p>As a side note, here is what the master secret look like when mitmproxy records it (that&rsquo;s the file I passed to WireShark):</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Content of sslkeylogfile</span>
CLIENT_RANDOM 5bdb7b7d88a325a08ee922a89b7b8acbbcda36f7d800c4e2f763b4689cfd870b 083f22af3099558997f784c47c4145dd9155c20f97fa5701bffe7003d80c7ad31801cfabb9be5838bf8f4f58e6b971f7
SERVER_HANDSHAKE_TRAFFIC_SECRET caa526a0b8e35551a2feee9de685e74547a7b0abc3ae5422a4bebe42d74132b4 7ac126e6a9b651ee9585a902248ac5bc5cdfa3a8989852f491b52ec013a9be170dce24076c305c5b9e7209c325a9f530
CLIENT_HANDSHAKE_TRAFFIC_SECRET caa526a0b8e35551a2feee9de685e74547a7b0abc3ae5422a4bebe42d74132b4 37fa20e94a385b79901a0615ef7c2de091e98757e85958deb9a242a3b0bed74e3be290d816555a3da816dd60d4f0c9f3
EXPORTER_SECRET caa526a0b8e35551a2feee9de685e74547a7b0abc3ae5422a4bebe42d74132b4 d436ff8840245be887e15d11000a98d971df4f1f0d825b7eb470a37fe2e9f7d1759967fe52e055cb9b5e74373e36f276
SERVER_TRAFFIC_SECRET_0 caa526a0b8e35551a2feee9de685e74547a7b0abc3ae5422a4bebe42d74132b4 615847eb91285a78981cf5072a9597e2ef4549c92d695818b9e05c270950b5ec88fcb62969b353b38ea2cd18597ee01d
CLIENT_TRAFFIC_SECRET_0 caa526a0b8e35551a2feee9de685e74547a7b0abc3ae5422a4bebe42d74132b4 4705201529b85b5cbdcbd74dfdf5cf2019ff9e520de551d2aaaa14962668ed3aa0a79416d1795d5eb53be93ddeb077de
</code></pre></div><p>The master secret is comprised of 96 hexadecimal characters, which corresponds to 48 bytes.</p>
</blockquote>
<p>It seems like mitmproxy does not support server-side initiated TLS renegotiation. Looking at its source code, it seems like everything after the end of the first handshake is considered to be data, and subsequent Handshake Messages make mitmproxy &ldquo;hang&rdquo;.</p>
<p>Now, why would TLS renegotiation be necessary after the HTTP request is sent? The issue named <a href="https://github.com/Venafi/vcert/issues/148">Venafi Issuer error when configuring cert-manager. &ldquo;local error: tls: no renegotiation&rdquo;</a> gives us a clue: Microsoft IIS, which is the web server used by Venafi TPP, is capable of authenticating an incoming connection using a client certificate depending on the HTTP request&rsquo;s URL path. Looking at the IIS configuration, we can see that the <code>/vedauth</code> endpoint has its &ldquo;client certificate&rdquo; settings configured to &ldquo;Accept&rdquo;:</p>
<p><img src="ssl-settings-accept.png" alt=""></p>
<p>Let us see this behavior in action by creating a TLS tunnel using openssl. With the path <code>/vedsdk</code>, we can see that openssl does not seem to renegotiate the TLS connection:</p>
<script id="asciicast-cAS7XfBwpKby1F7vHZOXRAqZK" src="https://asciinema.org/a/cAS7XfBwpKby1F7vHZOXRAqZK.js" async></script>
<p>The HTTP request I made was:</p>
<div class="highlight"><pre class="chroma"><code class="language-http" data-lang="http"><span class="err">HTTP /vedsdk/ HTTP/1.1
</span><span class="err">Host: venafi-tpp.platform-ops.jetstack.net
</span><span class="err">Content-Length: 0
</span></code></pre></div><p>With the endpoint <code>/vedauth</code>, which is the one for which mitmproxy is hanging on, openssl does two TLS negotiations:</p>
<script id="asciicast-nrlOK86ycQ8Legbz7wtYaoUWA" src="https://asciinema.org/a/nrlOK86ycQ8Legbz7wtYaoUWA.js" async></script>
<p>The request was:</p>
<div class="highlight"><pre class="chroma"><code class="language-http" data-lang="http"><span class="err">HTTP /vedauth/ HTTP/1.1
</span><span class="err">Host: venafi-tpp.platform-ops.jetstack.net
</span><span class="err">Content-Length: 0
</span></code></pre></div><p>In the first example (<code>/vedsdk</code>), the HTTP response is sent immediately without any TLS negotiation. In the second example (<code>/vedauth</code>), a TLS renegotiation is performed right after the HTTP request is sent, and the HTTP response is sent over this new TLS session.</p>
<p>The only explanation for this behavior is that this allows IIS to refuse clients that present an invalid client certificates only for paths for which client certificates are enabled, instead of refusing to serve all paths. I would need to learn a bit more about TLS and how IIS is able to give the information about the identity of a client certificate to the HTTP layer to know whether it should look for an <code>Authorization: Bearer foo</code> HTTP header.</p>
<p>The only workaround I have come up with is to turn the client certificate option to &ldquo;Ignore&rdquo;:</p>
<p><img src="ssl-settings-ignore.png" alt=""></p>
<p>This time, vcert over mitmproxy works!</p>
<p><img src="vcert-working.png" alt=""></p>
<p>One thing I would like to do in the future is to add support for TLS renegotiation to mitmproxy!</p>

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2021/mitmproxy-tls-renegotiation-debugging-story/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
        
        <div style="float: right;">
            <p>Tags:
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/debugging/"> debugging </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/mitmproxy/"> mitmproxy </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/tls/"> tls </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/wireshark/"> wireshark </a>
                
                
                
        </div>
        <div class="clearit"></div>
        
        
        
        
        
    </div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
