<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.64.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="MaÃ«l Valais"><meta name="description" content=""><meta property="og:title" content="Writing a good Go SDK" />
<meta property="og:description" content="The typical way of building a client in Go is to pass a *http.Client in order to let the caller set timeouts and so on. See godo (Digital Ocean API client) for a good way of doing it.
Another good practice is to avoid hidden network calls. For example, most Go users do not expect a NewClient function to do a network call. Prefer using a dedicated function such as client." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/writing-a-good-go-sdk/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/writing-a-good-go-sdk/cover-writing-a-good-go-sdk.png" />
<meta property="article:published_time" content="2020-05-08T15:00:27+02:00" />
<meta property="article:modified_time" content="2020-05-08T15:00:27+02:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/writing-a-good-go-sdk/cover-writing-a-good-go-sdk.png"/>

<meta name="twitter:title" content="Writing a good Go SDK"/>
<meta name="twitter:description" content="The typical way of building a client in Go is to pass a *http.Client in order to let the caller set timeouts and so on. See godo (Digital Ocean API client) for a good way of doing it.
Another good practice is to avoid hidden network calls. For example, most Go users do not expect a NewClient function to do a network call. Prefer using a dedicated function such as client."/>

  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Writing a good Go SDK | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">08</span>
<span class="rest">May 2020</span>
</div>
</div>

<div class="matter">
<h1 class="title">Writing a good Go SDK</h1>
</div>
</div>
<div class="markdown">
<p>The typical way of building a client in Go is to pass a <code>*http.Client</code> in
order to let the caller set timeouts and so on. See <a href="https://github.com/digitalocean/godo/blob/97ac73b1d53e23afa2700e9f97d5eeb1f3641e3f/godo.go#L153-L188">godo</a> (Digital Ocean
API client) for a good way of doing it.</p>
<p>Another good practice is to avoid hidden network calls. For example, most
Go users do not expect a <code>NewClient</code> function to do a network call. Prefer
using a dedicated function such as <code>client.Auth</code>.</p>
<p>In the [docker][] client</p>
<p>[docker]: <a href="https://github.com/moby/moby/blob/f5bb374a0c6260721ac551b232e8eac02b7d2674/client/client.go#L146-L150">https://github.com/moby/moby/blob/f5bb374a0c6260721ac551b232e8eac02b7d2674/client/client.go#L146-L150</a>)</p>
<blockquote>
<p><code>NewClient</code> should probably only take an <code>*http.Client</code> and work from
there.</p>
</blockquote>
<p>I think <code>NewClient</code> should only take a token and we also offer the user a
way to give the token:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Client</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetToken</span><span class="p">(</span>
</code></pre></div><ol>
<li><a href="#unleash">Unleash</a></li>
<li><a href="#stripe">Stripe</a></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#saltstack-client-r3labsgo-salt">Saltstack client (r3labs/go-salt)</a></li>
<li><a href="#docker-engine-api-client">Docker Engine API client</a></li>
<li><a href="#heroku">Heroku</a></li>
<li><a href="#slack">Slack</a></li>
<li><a href="#scaleway">Scaleway</a></li>
</ol>
<h2 id="unleash">Unleash</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/Unleash/unleash-client-go&#34;</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">unleash</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span>
        <span class="nx">unleash</span><span class="p">.</span><span class="nf">WithListener</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">unleash</span><span class="p">.</span><span class="nx">DebugListener</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">unleash</span><span class="p">.</span><span class="nf">WithAppName</span><span class="p">(</span><span class="s">&#34;my-application&#34;</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">unleash</span><span class="p">.</span><span class="nf">WithUrl</span><span class="p">(</span><span class="s">&#34;http://unleash.herokuapp.com/api/&#34;</span><span class="p">)</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Example of API call.
</span><span class="c1"></span>    <span class="nx">unleash</span><span class="p">.</span><span class="nf">IsEnabled</span><span class="p">(</span><span class="s">&#34;app.ToggleX&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="stripe">Stripe</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="nx">stripe</span> <span class="s">&#34;github.com/stripe/stripe-go&#34;</span>
    <span class="s">&#34;github.com/stripe/stripe-go/client&#34;</span>
<span class="p">)</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">httpClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
    <span class="nx">backends</span> <span class="o">:=</span> <span class="nx">stripe</span><span class="p">.</span><span class="nf">NewBackends</span><span class="p">(</span><span class="nx">httpClient</span><span class="p">)</span>
    <span class="nx">client</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="s">&#34;token&#34;</span><span class="p">,</span> <span class="nx">backends</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="redis">Redis</h2>
<p>Doesn&rsquo;t use HTTP anyway. But you can pass a Dialer function that creates a
<code>net.Conn</code>. Since Redis is using TCP directly, the Redis client has to
offer everything itself (e.g. DialTimeout).</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/go-redis/redis&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Addr</span><span class="p">:</span> <span class="s">&#34;localhost:6379&#34;</span><span class="p">,</span><span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">}</span>
    <span class="nx">client</span> <span class="o">:=</span> <span class="nx">redis</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="saltstack-client-r3labsgo-salt">Saltstack client (r3labs/go-salt)</h2>
<p>The <a href="https://github.com/r3labs/go-salt/blob/e6bcc1482122fbfbb41c8c5d7204e067e97a4266/client.go#L18">NewClient</a> does a network call. That&rsquo;s pretty uncommon
to do that in Go.</p>
<p>There is no way to pass a <code>*http.Client</code> in <code>NewClient</code>. But you can by
going through some hoops.</p>
<p>Also, the authentication should create a new <code>*http.Client</code> instead of
mutating the <code>conn.AuthToken</code> value.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="s">&#34;github.com/r3labs/go-salt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Using NewClient
</span><span class="c1"></span>    <span class="nx">opts</span> <span class="o">:=</span> <span class="nx">salt</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Host</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">Username</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">Password</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">}</span>
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">salt</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>

    <span class="c1">// With a timeout using *http.Client
</span><span class="c1"></span>    <span class="nx">httpClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
    <span class="nx">conn</span> <span class="o">:=</span> <span class="nx">salt</span><span class="p">.</span><span class="nx">Connector</span><span class="p">{</span><span class="nx">Client</span><span class="p">:</span> <span class="nx">httpClient</span><span class="p">,</span> <span class="nx">AuthToken</span><span class="p">:</span> <span class="s">&#34;token&#34;</span><span class="p">}</span>
    <span class="nx">conn</span><span class="p">.</span><span class="nf">Authenticate</span><span class="p">(</span><span class="p">)</span>
    <span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">salt</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Connector</span><span class="p">:</span> <span class="nx">conn</span><span class="p">}</span>
    <span class="nx">job</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Job</span><span class="p">(</span><span class="s">&#34;foo&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="docker-engine-api-client">Docker Engine API client</h2>
<p>The <a href="https://github.com/moby/moby/blob/f5bb374a0c6260721ac551b232e8eac02b7d2674/client/client.go#L119">dockerengine.NewClient</a> does return an error, which is kind of
unusual for NewClient in Go. The only thing they do is to check that the
transport field (<code>http.Transport</code>) is in fact a <code>http.RoundTripper</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="s">&#34;github.com/moby/moby/client&#34;</span>
<span class="p">)</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">httpClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewClientWithOpts</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">WithHTTPClient</span><span class="p">(</span><span class="nx">httpClient</span><span class="p">)</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div><h2 id="heroku">Heroku</h2>
<p>Very clean! Many globals, but it&rsquo;s just for ease of use: everything can be
used without using the global state (<code>heroku.DefaultTransport</code>).
<a href="https://github.com/heroku/heroku-go/blob/master/v5/transport.go">https://github.com/heroku/heroku-go/blob/master/v5/transport.go</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="nx">heroku</span> <span class="s">&#34;github.com/heroku/heroku-go/v5&#34;</span>
<span class="p">)</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
        <span class="nx">Timeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
        <span class="nx">Transport</span><span class="p">:</span> <span class="nx">heroku</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span><span class="nx">BearerToken</span><span class="p">:</span> <span class="s">&#34;token&#34;</span><span class="p">}</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">heroku</span><span class="p">.</span><span class="nf">NewService</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
    <span class="nx">addons</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">AddOnList</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">heroku</span><span class="p">.</span><span class="nx">ListRange</span><span class="p">{</span><span class="nx">Field</span><span class="p">:</span> <span class="s">&#34;name&#34;</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="slack">Slack</h2>
<p>Very good!!!
<a href="https://github.com/nlopes/slack/blob/e5749f13b5af3c139165ab4180a95bb06a60128b/slack.go#L68">https://github.com/nlopes/slack/blob/e5749f13b5af3c139165ab4180a95bb06a60128b/slack.go#L68</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/nlopes/slack&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">httpClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">}</span>
    <span class="nx">api</span> <span class="o">:=</span> <span class="nx">slack</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;token&#34;</span><span class="p">,</span> <span class="nx">slack</span><span class="p">.</span><span class="nf">OptionHTTPClient</span><span class="p">(</span><span class="nx">httpClient</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">groups</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">GetGroups</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="scaleway">Scaleway</h2>
<p><a href="https://github.com/scaleway/scaleway-sdk-go">https://github.com/scaleway/scaleway-sdk-go</a></p>
<p>And they use an HTTP recorder &ldquo;Ã  la Jest Snapshot&rdquo;!</p>

</div>
<a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/writing-a-good-go-sdk/index.md">ð Edit this page and propose a change!</a>
<div class="tags">









</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="ð¬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
