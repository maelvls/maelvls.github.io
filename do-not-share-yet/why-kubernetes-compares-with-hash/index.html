<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.75.1" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="description" content=""><meta property="og:title" content="Why Kubernetes Compares With Hash" />
<meta property="og:description" content="In Kubernetes, the replica set controller uses a hashing mechanism to compare objects. Pods that are owned by a replica set have a label that is used to remember what the hash of the pod template that led to this pod spec:
kind:Podmetadata:labels:pod-template-hash:775855699bIn this post, I want to present the advantages and limitations of using a hash function in this context.
✅ Pros: works around the fact that child object might get mutated or defaulted, which means the reflect." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/why-kubernetes-compares-with-hash/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/why-kubernetes-compares-with-hash/cover-why-kubernetes-compares-with-hash.png" />
<meta property="article:published_time" content="2020-07-08T11:55:27+02:00" />
<meta property="article:modified_time" content="2020-07-08T11:55:27+02:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/why-kubernetes-compares-with-hash/cover-why-kubernetes-compares-with-hash.png"/>

<meta name="twitter:title" content="Why Kubernetes Compares With Hash"/>
<meta name="twitter:description" content="In Kubernetes, the replica set controller uses a hashing mechanism to compare objects. Pods that are owned by a replica set have a label that is used to remember what the hash of the pod template that led to this pod spec:
kind:Podmetadata:labels:pod-template-hash:775855699bIn this post, I want to present the advantages and limitations of using a hash function in this context.
✅ Pros: works around the fact that child object might get mutated or defaulted, which means the reflect."/>
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Why Kubernetes Compares With Hash | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">08</span>
<span class="rest">Jul 2020</span>
</div>
</div>

<div class="matter">
<h1 class="title">Why Kubernetes Compares With Hash</h1>
</div>
</div>
<div class="markdown">
<p>In Kubernetes, the replica set controller uses a hashing mechanism to compare objects. Pods that are owned by a replica set have a label that is used to remember what the hash of the pod template that led to this pod spec:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">pod-template-hash</span><span class="p">:</span><span class="w"> </span><span class="l">775855699b</span><span class="w">
</span></code></pre></div><p>In this post, I want to present the advantages and limitations of using a hash function in this context.</p>
<p>✅ <strong>Pros</strong>: works around the fact that child object might get mutated or defaulted, which means the <code>reflect.DeepEqual</code> can&rsquo;t work (<strong>what about performance???</strong>)</p>
<p>❌ <strong>Cons</strong>: if the child gets updated, the parent cannot know that it has been changed since the hash only works in one way. (<strong>talk about replica set mapping to multiple pods</strong>)</p>
<ul>
<li>why is it a label and not an annotation?</li>
</ul>
<p>Looks like the hash is created <a href="https://github.com/kubernetes/kubernetes/blob/7e75a5ef/pkg/controller/deployment/sync.go#L189">in the replicaset sync func</a> and it uses the <a href="https://github.com/kubernetes/kubernetes/blob/7e75a5ef/pkg/controller/controller_utils.go#L1130-L1145"><code>ComputeHash</code></a> func which uses <a href="https://golang.org/pkg/hash/fnv/#New32">fnv.New32a</a> from the std lib:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ComputeHash returns a hash value calculated from pod template and
</span><span class="c1">// a collisionCount to avoid hash collision. The hash will be safe encoded to
</span><span class="c1">// avoid bad words.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ComputeHash</span><span class="p">(</span><span class="nx">template</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">PodTemplateSpec</span><span class="p">,</span> <span class="nx">collisionCount</span> <span class="o">*</span><span class="kt">int32</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">podTemplateSpecHasher</span> <span class="o">:=</span> <span class="nx">fnv</span><span class="p">.</span><span class="nf">New32a</span><span class="p">()</span>
    <span class="nx">hashutil</span><span class="p">.</span><span class="nf">DeepHashObject</span><span class="p">(</span><span class="nx">podTemplateSpecHasher</span><span class="p">,</span> <span class="o">*</span><span class="nx">template</span><span class="p">)</span>

    <span class="c1">// Add collisionCount in the hash if it exists.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">collisionCount</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">collisionCountBytes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint32</span><span class="p">(</span><span class="nx">collisionCountBytes</span><span class="p">,</span> <span class="nb">uint32</span><span class="p">(</span><span class="o">*</span><span class="nx">collisionCount</span><span class="p">))</span>
        <span class="nx">podTemplateSpecHasher</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">collisionCountBytes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">SafeEncodeString</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">podTemplateSpecHasher</span><span class="p">.</span><span class="nf">Sum32</span><span class="p">()))</span>
<span class="p">}</span>
</code></pre></div><p>and the <a href="https://github.com/kubernetes/kubernetes/blob/7e75a5ef/pkg/util/hash/hash.go#L25-L37"><code>DeepHashObject</code></a> looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DeepHashObject writes specified object to hash using the spew library
</span><span class="c1">// which follows pointers and prints actual values of the nested objects
</span><span class="c1">// ensuring the hash does not change when a pointer changes.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DeepHashObject</span><span class="p">(</span><span class="nx">hasher</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">Hash</span><span class="p">,</span> <span class="nx">objectToWrite</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">hasher</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
    <span class="nx">printer</span> <span class="o">:=</span> <span class="nx">spew</span><span class="p">.</span><span class="nx">ConfigState</span><span class="p">{</span>
        <span class="nx">Indent</span><span class="p">:</span>         <span class="s">&#34; &#34;</span><span class="p">,</span>
        <span class="nx">SortKeys</span><span class="p">:</span>       <span class="kc">true</span><span class="p">,</span>
        <span class="nx">DisableMethods</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">SpewKeys</span><span class="p">:</span>       <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">printer</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">hasher</span><span class="p">,</span> <span class="s">&#34;%#v&#34;</span><span class="p">,</span> <span class="nx">objectToWrite</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>So the hashing mechanism uses <a href="https://github.com/davecgh/go-spew">davecgh/go-spew</a> to turn the object into a string, and then uses the <code>fnv</code> std library to hash that string.</p>
<h2 id="benchmarking-two-hashing-functions">Benchmarking two hashing functions</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;hash&#34;</span>
    <span class="s">&#34;hash/fnv&#34;</span>
    <span class="s">&#34;testing&#34;</span>

    <span class="s">&#34;github.com/davecgh/go-spew/spew&#34;</span>
    <span class="s">&#34;github.com/mitchellh/hashstructure&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">ComplexStruct</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span>     <span class="kt">string</span>
    <span class="nx">Age</span>      <span class="kt">uint</span>
    <span class="nx">Metadata</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">v</span> <span class="p">=</span> <span class="nx">ComplexStruct</span><span class="p">{</span>
    <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;mitchellh&#34;</span><span class="p">,</span>
    <span class="nx">Age</span><span class="p">:</span>  <span class="mi">64</span><span class="p">,</span>
    <span class="nx">Metadata</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
        <span class="s">&#34;car&#34;</span><span class="p">:</span>      <span class="kc">true</span><span class="p">,</span>
        <span class="s">&#34;location&#34;</span><span class="p">:</span> <span class="s">&#34;California&#34;</span><span class="p">,</span>
        <span class="s">&#34;siblings&#34;</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;Bob&#34;</span><span class="p">,</span> <span class="s">&#34;John&#34;</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkMitchellhHashstructure</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">hashstructure</span><span class="p">.</span><span class="nf">Hash</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">BenchmarkKubernetesComputeHash</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">hasher</span> <span class="o">:=</span> <span class="nx">fnv</span><span class="p">.</span><span class="nf">New32a</span><span class="p">()</span>
        <span class="nf">DeepHashObject</span><span class="p">(</span><span class="nx">hasher</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
        <span class="nx">_</span> <span class="p">=</span> <span class="nx">hasher</span><span class="p">.</span><span class="nf">Sum32</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// From https://github.com/kubernetes/kubernetes/blob/7e75a5ef/pkg/util/hash/hash.go#L25-L37
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DeepHashObject</span><span class="p">(</span><span class="nx">hasher</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">Hash</span><span class="p">,</span> <span class="nx">objectToWrite</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
    <span class="nx">hasher</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
    <span class="nx">printer</span> <span class="o">:=</span> <span class="nx">spew</span><span class="p">.</span><span class="nx">ConfigState</span><span class="p">{</span>
        <span class="nx">Indent</span><span class="p">:</span>         <span class="s">&#34; &#34;</span><span class="p">,</span>
        <span class="nx">SortKeys</span><span class="p">:</span>       <span class="kc">true</span><span class="p">,</span>
        <span class="nx">DisableMethods</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">SpewKeys</span><span class="p">:</span>       <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">printer</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">hasher</span><span class="p">,</span> <span class="s">&#34;%#v&#34;</span><span class="p">,</span> <span class="nx">objectToWrite</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>The winner seems to be the Kubernetes' ComputeHash function, although it relies on spew to generate a string. I guess most of the time spent by hashstructure.Hash is due to the reflect package?</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% go <span class="nb">test</span> -bench .
BenchmarkMitchellhHashstructure-8         <span class="m">368101</span>              3.127 µs/op
BenchmarkKubernetesComputeHash-8          <span class="m">456028</span>              2.704 µs/op
</code></pre></div><h2 id="other-clues">Other clues</h2>
<pre><code>  controller-revision-hash: 6f7768f569
  k8s-app: kube-proxy
  pod-template-generation: &quot;7&quot;

  k3s.io/node-config-hash
</code></pre>

</div>
<a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/why-kubernetes-compares-with-hash/index.md">📝 Edit this page and propose a change!</a>
<div class="tags">









</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
