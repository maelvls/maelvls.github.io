<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.147.6">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="keywords" content="kubernetes,networking"><meta name="description" content="Some pods were unable to connect to the kube-proxy pod on one of my GKE Kubernetes clusters. This post present an in-depth investigation using tcpdump, wireshark and iptables tracing."><meta property="og:url" content="https://maelvls.dev/do-not-share-yet/debugging-kubernetes-networking/">
  <meta property="og:site_name" content="maelvls dev blog">
  <meta property="og:title" content="Debugging Kubernetes Networking: my kube-dns is not working!">
  <meta property="og:description" content="Some pods were unable to connect to the kube-proxy pod on one of my GKE Kubernetes clusters. This post present an in-depth investigation using tcpdump, wireshark and iptables tracing.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="2020">
    <meta property="article:published_time" content="2020-01-26T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-01-26T00:00:00+00:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Networking">
    <meta property="og:image" content="https://maelvls.dev/do-not-share-yet/debugging-kubernetes-networking/cover-debug-kubernetes-networking.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/debugging-kubernetes-networking/cover-debug-kubernetes-networking.png">
  <meta name="twitter:title" content="Debugging Kubernetes Networking: my kube-dns is not working!">
  <meta name="twitter:description" content="Some pods were unable to connect to the kube-proxy pod on one of my GKE Kubernetes clusters. This post present an in-depth investigation using tcpdump, wireshark and iptables tracing.">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Debugging Kubernetes Networking: my kube-dns is not working! | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://x.com/maelvls"><i title="X" class="icons fab fa-x"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">26</span>
                <span class="rest">
                    
                    Jan2020
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">Debugging Kubernetes Networking: my kube-dns is not working!</h1>
        </div>
        
        <span style="font-size: xx-small; text-align: right">
            cross-post <a href="https://dev.to/maelvls/deep-dive-into-kubernetes-networking-my-kube-dns-is-not-working-2b8j">
                <i title="Maël Valais's DEV Community Profile" class="icons fab fa-dev"></i>
            </a>
        </span>
        
    </div>
    <div class="markdown">
        <p>When I scaled my GKE cluster from one node to two nodes, I realised there was some DNS issues with one of the pods on the new Node 2 (that&rsquo;s what I initially thought).</p>
<p><img src="diagram-node-2-dns-not-working.png" alt="network diagram of the cluster where DNS not working in a pod of Node 2"></p>
<p>So I went into pod-on-2 (10.24.12.40) and checked that DNS wasn&rsquo;t working. What I did is run</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% gcloud compute ssh node-2
</span></span><span class="line"><span class="cl">% docker run --rm -it --net<span class="o">=</span>container:<span class="k">$(</span>docker ps <span class="p">|</span> grep POD_pod-on-2 <span class="p">|</span> head -1 <span class="p">|</span> cut -f1 -d<span class="s2">&#34; &#34;</span><span class="k">)</span> nicolaka/netshoot
</span></span><span class="line"><span class="cl">% nslookup github.com
</span></span><span class="line"><span class="cl"><span class="p">;;</span> connection timed out<span class="p">;</span> no servers could be reached
</span></span></code></pre></div><p>Let&rsquo;s see if this DNS request actually goes out of the container. So I ran tcpdump on the <code>cbr0</code> interface on node 2. <code>cbr0</code> is the linux bridge used by Kubernetes (the bridge and the interface have the same name). Using Wireshark on top of tcpdump gives me easier-to-explore results:</p>
<p><img src="wireshark-node-2-cbr0-and-terminal.png" alt="Wireshark running on interface cbr0 on node 2"></p>
<p>Note that the actual name of Node 2 is <em>gke-august-period-234610-worker-micro-1de60498-9gsb</em> (now, you know!). Here is the command I used for opening wireshark on Node 2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% gcloud compute ssh node-2 --command <span class="s2">&#34;docker run --rm --net=host corfr/tcpdump -i cbr0 -U -w - &#39;not port 22&#39;&#34;</span> <span class="p">|</span> wireshark -k -i -
</span></span><span class="line"><span class="cl">tcpdump: listening on cbr0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span></code></pre></div><p>What we see is that <code>cbr0</code> properly receives UDP packets coming from the pod <code>10.24.12.40</code>, and that the DNS address is <code>10.27.240.10</code>. I double checked, <code>10.27.240.10</code> is the DNS address set in <code>/etc/resolve.conf</code> inside containers in this pod.</p>
<p>Here is the network setup with the IPs to get a better picture:</p>
<p><img src="diagram-pod-ips.png" alt="Network diagram of the Kubernetes cluster with two nodes and two pods and with IPs displayed"></p>
<p>Let&rsquo;s check that <code>10.27.240.10</code> is actually a service:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% kubectl -n kube-system get service kube-dns
</span></span><span class="line"><span class="cl">NAME       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>         AGE
</span></span><span class="line"><span class="cl">kube-dns   ClusterIP   10.27.240.10   &lt;none&gt;        53/UDP,53/TCP   34d
</span></span></code></pre></div><p>We now know that the DNS used in all the pods is the ClusterIP of the kube-dns service. That&rsquo;s not a real pod IP, so the iptables should be translating that into an actual pod IP.</p>
<p>Now that we know that the packet goes to <code>cbr0</code>, is it forwarded to Node 2&rsquo;s <code>eth0</code>? I used Wireshark again, but on <code>eth0</code> this time:</p>
<p><img src="wireshark-node-2-eth0.png" alt="Wireshark on eth0 of Node 2"></p>
<p>Apparently, the packet destination has been re-written from <code>10.27.240.10</code> to <code>10.24.9.31</code> (an actual pod IP) which is good sign. This pod IP corresponds to one of the replicas of kube-dns on node 1, which seems fine.</p>
<p>At this point, I was wondering: are UDP packets from node 2 to node 1 properly routed?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mvalais@node-2 ~ $ docker run -it --rm --net<span class="o">=</span>host nicolaka/netshoot
</span></span><span class="line"><span class="cl">% nslookup github.com 10.27.240.10
</span></span><span class="line"><span class="cl">Server:		10.27.240.10
</span></span><span class="line"><span class="cl">Address:	10.27.240.10#53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Non-authoritative answer:
</span></span><span class="line"><span class="cl">Name:	github.com
</span></span><span class="line"><span class="cl">Address: 192.30.253.113
</span></span></code></pre></div><p>Wait what? The DNS query to <code>10.27.240.10</code> works from the host but not from the pod? At this point, my guesses were:</p>
<ol>
<li>something wrong with the routes on the host,</li>
<li>something is wrong with networking on node 1</li>
<li>something is wrong with the iptables of node 2</li>
<li>an issue with routing of <code>10.24.0.0/14</code> on the VPC (it&rsquo;s the CIDR allocated to this GKE cluster; the nodes themselves receive <code>/24</code> CIDRs from this range)</li>
</ol>
<p>Let&rsquo;s rule (1) out. Here is the L3 routing table on node 2:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mvalais@node-2 ~ $ docker run -it --rm --net<span class="o">=</span>host nicolaka/netshoot
</span></span><span class="line"><span class="cl">% ip route
</span></span><span class="line"><span class="cl">default via 10.142.0.1 dev eth0    proto dhcp   src 10.142.15.206 metric <span class="m">1024</span>
</span></span><span class="line"><span class="cl">default via 10.142.0.1 dev eth0    proto dhcp
</span></span><span class="line"><span class="cl">10.24.12.0/24          dev cbr0    proto kernel src 10.24.12.1
</span></span><span class="line"><span class="cl">10.142.0.1             dev eth0    proto dhcp   src 10.142.15.206 metric <span class="m">1024</span>
</span></span><span class="line"><span class="cl">10.142.0.1             dev eth0    proto dhcp
</span></span><span class="line"><span class="cl">169.254.123.0/24       dev docker0 proto kernel src 169.254.123.1 linkdown
</span></span></code></pre></div><p>Remembering that Node 2&rsquo;s eth0 has the IP <code>10.142.15.206</code>, it looks like all packets that are meant for Node 1&rsquo;s kube-dns will use the first rule. So no problem on this side.</p>
<p>The (2) guess is easy to check: I ran tcpdump with wireshark on the eth0 of node 1. No trace of an UDP packet coming from <code>10.24.12.40</code>. So the packets don&rsquo;t even reach the node 1.</p>
<p>Let&rsquo;s recap all we know: the packet goes from the pod&rsquo;s eth0 to the linux bridge, and is then rewritten and forwarded to the host&rsquo;s eth0.</p>
<p><img
src="diagram-node-2-iptables-flow.png"
width="400" alt="On Node 2, packet goes from pod's eth0 to host's cbr0 and
then host's eth0" /></p>
<p>So we are left with</p>
<ol>
<li>something is wrong with the iptables of node 2</li>
<li>an issue with routing of <code>10.24.0.0/14</code> on the VPC</li>
</ol>
<p>I now realise that I could have ruled out the iptable issue since I could see the packet on Node 2&rsquo;s eth0 interface. But I wanted to know how that packet was handled anyway!</p>
<p>So let&rsquo;s dive into what iptables is doing to this packet. First, let&rsquo;s see if a conntrack entry exists due to the DNAT rewriting:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="c1"># From the pod on Node 2:</span>
</span></span><span class="line"><span class="cl"><span class="o">% nslookup github.com
</span></span></span><span class="line"><span class="cl"><span class="o">%</span> <span class="n">mvalais</span><span class="o">@</span><span class="n">node</span><span class="m">-2</span> <span class="o">~</span> <span class="o">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">net</span><span class="o">=</span><span class="n">host</span> <span class="o">--</span><span class="n">privileged</span> <span class="o">--</span><span class="n">rm</span> <span class="n">missioncriticalkubernetes</span><span class="o">/</span><span class="n">conntrack</span> <span class="o">-</span><span class="n">L</span> <span class="o">|</span> <span class="n">grep</span> <span class="m">10.24</span>
</span></span><span class="line"><span class="cl"><span class="n">conntrack</span> <span class="nf">v1.4.4 </span><span class="p">(</span><span class="n">conntrack</span><span class="o">-</span><span class="n">tools</span><span class="p">)</span><span class="o">:</span> <span class="m">52</span> <span class="n">flow</span> <span class="n">entries</span> <span class="n">have</span> <span class="n">been</span> <span class="n">shown.</span>
</span></span><span class="line"><span class="cl"><span class="n">udp</span> <span class="m">17</span> <span class="m">26</span>  <span class="n">src</span><span class="o">=</span><span class="m">10.24.12.40</span>    <span class="n">dst</span><span class="o">=</span><span class="m">10.27.240.10</span> <span class="n">sport</span><span class="o">=</span><span class="m">57400</span> <span class="n">dport</span><span class="o">=</span><span class="m">53</span> <span class="n">[UNREPLIED]</span> <span class="n">src</span><span class="o">=</span><span class="m">10.24.9.31</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.24.12.40</span>     <span class="n">sport</span><span class="o">=</span><span class="m">53</span> <span class="n">dport</span><span class="o">=</span><span class="m">57400</span>           <span class="n">mark</span><span class="o">=</span><span class="m">0</span> <span class="n">use</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># From Node 2&#39;s host networking:</span>
</span></span><span class="line"><span class="cl"><span class="o">% nslookup github.com 10.27.240.10
</span></span></span><span class="line"><span class="cl"><span class="o">%</span> <span class="n">mvalais</span><span class="o">@</span><span class="n">node</span><span class="m">-2</span> <span class="o">~</span> <span class="o">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">net</span><span class="o">=</span><span class="n">host</span> <span class="o">--</span><span class="n">privileged</span> <span class="o">--</span><span class="n">rm</span> <span class="n">missioncriticalkubernetes</span><span class="o">/</span><span class="n">conntrack</span> <span class="o">-</span><span class="n">L</span> <span class="o">|</span> <span class="n">grep</span> <span class="m">10.24</span>
</span></span><span class="line"><span class="cl"><span class="n">udp</span> <span class="m">17</span> <span class="m">175</span> <span class="n">src</span><span class="o">=</span><span class="m">10.142.15.206</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.27.240.10</span> <span class="n">sport</span><span class="o">=</span><span class="m">37337</span> <span class="n">dport</span><span class="o">=</span><span class="m">53</span>             <span class="n">src</span><span class="o">=</span><span class="m">10.24.9.31</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.142.15.206</span> <span class="n">sport</span><span class="o">=</span><span class="m">53</span> <span class="n">dport</span><span class="o">=</span><span class="m">37337</span> <span class="n">[ASSURED]</span> <span class="n">mark</span><span class="o">=</span><span class="m">0</span> <span class="n">use</span><span class="o">=</span><span class="m">1</span>
</span></span></code></pre></div><p>Coming from the pod, we see that the DNAT rewriting happened but the connection status is UNREPLIED. Coming from the host, the DNAT rewriting also happened but the connection status is ASSURED, which means a reply has been given.</p>
<p>Now, the deep dive: let&rsquo;s use iptables&rsquo; <code>TRACE</code> target to know how this packet gets rewritten when coming from the pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="c1"># From Node 2</span>
</span></span><span class="line"><span class="cl"><span class="o">% sudo modprobe ipt_LOG
</span></span></span><span class="line"><span class="cl"><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">s</span> <span class="m">10.24.0.0</span><span class="o">/</span><span class="m">16</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
</span></span><span class="line"><span class="cl"><span class="o">% sudo iptables -A PREROUTING -t raw -d 10.24.0.0/16 -j TRACE
</span></span></span><span class="line"><span class="cl"><span class="o">%</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">net</span><span class="o">=</span><span class="n">container</span><span class="o">:$</span><span class="p">(</span><span class="n">docker</span> <span class="n">ps</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">POD_pod</span><span class="o">-</span><span class="n">on</span><span class="m">-2</span> <span class="o">|</span> <span class="n">head</span> <span class="m">-1</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">f1</span> <span class="o">-</span><span class="n">d</span><span class="s">&#34; &#34;</span><span class="p">)</span> <span class="o">--</span><span class="n">privileged</span> <span class="n">nicolaka</span><span class="o">/</span><span class="n">netshoot</span> <span class="n">nslookup</span> <span class="n">github.com</span>
</span></span><span class="line"><span class="cl">% <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.179725]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">raw</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">2</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.200327]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>               <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.221171]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.241576]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">14</span>                <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.262385]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SVC</span><span class="o">-</span><span class="n">TCOU7JCQXEZGVUNU</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.284116]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SEP</span><span class="o">-</span><span class="n">MQYG7Z5PYI3N6YFY</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27.240.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.305838]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.326491]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.346973]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">FORWARD</span><span class="o">:</span><span class="kr">return</span><span class="o">:</span><span class="m">4</span>             <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.368068]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.389031]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="kr">return</span><span class="o">:</span><span class="m">1</span>            <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.410253]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">3</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.430735]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">USER</span><span class="o">:</span><span class="kr">return</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.451887]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">4</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.472366]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">ISOLATION</span><span class="o">-</span><span class="n">STAGE</span><span class="m">-1</span><span class="o">:</span><span class="kr">return</span><span class="o">:</span><span class="m">2</span> <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.494488]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">10</span>                   <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.515049]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.531693]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.547953]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="kr">return</span><span class="o">:</span><span class="m">2</span>            <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.564769]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.580978]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">IP</span><span class="o">-</span><span class="n">MASQ</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                       <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span><span class="line"><span class="cl"><span class="n">[90332.596840]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">4</span>                 <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24.12.40</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24.9.31</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</span></span></code></pre></div><p>The last list, <code>POSTROUTING</code>, makes it clear that the packet is properly sent to the host&rsquo;s <code>eth0</code> with <code>src 10.24.12.40</code> and <code>dst 10.24.9.31</code>. The packet should get to node 1 now!</p>
<p>I noticed that using <code>-j TRACE</code> is extremely expensive. For example, using <code>-p icmp</code> would result in pings going from 1ms (without tracing) to 500ms. I also overloaded one of the nodes by adding a rule that was &ldquo;too wide&rdquo; and nearly killed the entire node. Use tracing filters (<code>-s</code>, <code>-p</code>, <code>-d</code>) as narrow as possible!</p>
<p>So UDP traffic doesn&rsquo;t get routed. But what about ICMP and TCP packets? I had previously noticed that <code>ping</code> would work from 10.24.12.40 to 10.24.9.31.</p>
<p>Let&rsquo;s see if TCP traffic also works. This time, instead of ssh-ing into the nodes and running docker, I used <code>--generator=run-pod/v1</code> and <code>--override</code> in order to choose on which node the pod is launched. Here is a sample of what I give to <code>--override</code> for running a pod on <code>node-2</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">matchFields</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node-2]</span><span class="w">
</span></span></span></code></pre></div><p>From a pod on Node 1 (<code>10.24.9.32</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-host-a --overrides<span class="o">=</span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;spec&#34;:{&#34;affinity&#34;:{&#34;nodeAffinity&#34;:{&#34;requiredDuringSchedulingIgnoredDuringExecution&#34;:{&#34;nodeSelectorTerms&#34;:[{&#34;matchFields&#34;:[{&#34;key&#34;:&#34;metadata.name&#34;,&#34;operator&#34;:&#34;In&#34;,&#34;values&#34;:[&#34;node-1&#34;]}]}]}}}}}&#39;</span> --rm -i --tty --image nicolaka/netshoot
</span></span><span class="line"><span class="cl">% nc -v 10.24.12.41 <span class="m">80</span>
</span></span><span class="line"><span class="cl">Connection to 10.24.12.41 <span class="m">80</span> port <span class="o">[</span>tcp/http<span class="o">]</span> succeeded!
</span></span></code></pre></div><p>From a pod on Node 2 (<code>10.24.12.41</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-host-b --overrides<span class="o">=</span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;spec&#34;:{&#34;affinity&#34;:{&#34;nodeAffinity&#34;:{&#34;requiredDuringSchedulingIgnoredDuringExecution&#34;:{&#34;nodeSelectorTerms&#34;:[{&#34;matchFields&#34;:[{&#34;key&#34;:&#34;metadata.name&#34;,&#34;operator&#34;:&#34;In&#34;,&#34;values&#34;:[&#34;node-2&#34;]}]}]}}}}}&#39;</span> --rm -i --tty --image nicolaka/netshoot
</span></span><span class="line"><span class="cl">% nc -v -l <span class="m">80</span>
</span></span><span class="line"><span class="cl">Listening on <span class="o">[</span>0.0.0.0<span class="o">]</span> <span class="o">(</span>family 0, port 80<span class="o">)</span>
</span></span><span class="line"><span class="cl">Connection from 10.24.9.32 <span class="m">38274</span> received!
</span></span></code></pre></div><p>The traffic on 80/tcp definitely seems to work from Node 1 to Node 2! Now, let&rsquo;s try the same but with 53/tcp and from Node 2 to Node 1.</p>
<p>From pod on Node 1 (<code>10.24.9.32</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% nc -v -l <span class="m">53</span>
</span></span><span class="line"><span class="cl">Listening on <span class="o">[</span>0.0.0.0<span class="o">]</span> <span class="o">(</span>family 0, port 53<span class="o">)</span>
</span></span></code></pre></div><p>From pod on Node 2 (<code>10.24.12.41</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% curl 10.24.9.32:53
</span></span><span class="line"><span class="cl">curl: <span class="o">(</span>28<span class="o">)</span> Failed to connect to 10.24.9.32 port 53: Operation timed out
</span></span></code></pre></div><p>To recap, only 80/tcp, 443/tcp and icmp packets are routed. It&rsquo;s surprisingly very specific: what if the VPC firewall rules were off? That was my last guess, but I guess it should have been myst first&hellip;</p>
<p>Two weeks ago, I remember having deleted some left-over rules when I was playing with Kops. I might have deleted one of the rules that allowed this traffic to flow!</p>
<p>Here is what the UI shows:</p>
<p><img src="gcp-ui-vpc-firewall-rules.png" alt="Screenshot of the VPC interface on GCP, the 10.24.0.0 subnet doesn&rsquo;t seem to be allowed"></p>
<p>Even easier-to-read, using <code>gcloud</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% gcloud compute firewall-rules list
</span></span><span class="line"><span class="cl">NAME                   NETWORK  DIRECTION  PRIORITY ALLOW
</span></span><span class="line"><span class="cl">akrobateo-fw-traefik   default  INGRESS    <span class="m">1000</span>     tcp:80,tcp:443
</span></span><span class="line"><span class="cl">default-allow-icmp     default  INGRESS    <span class="m">65534</span>    icmp
</span></span><span class="line"><span class="cl">default-allow-internal default  INGRESS    <span class="m">65534</span>    tcp:0-65535,udp:0-65535,icmp
</span></span><span class="line"><span class="cl">default-allow-rdp      default  INGRESS    <span class="m">65534</span>    tcp:3389
</span></span><span class="line"><span class="cl">default-allow-ssh      default  INGRESS    <span class="m">65534</span>    tcp:22
</span></span></code></pre></div><p>How is the traffic using the <code>10.24.0.0/14</code> subnet supposed to be routed? This subnet was allocated to this GKE cluster; node 1 was given the CIDR <code>10.24.9.0/24</code> and node 2 was given the CIDR <code>10.24.12.0/24</code>.</p>
<p>So I added a new rule <code>gke-august-period-234610-all</code> (august-period-234610 is the name of my project); it looks like that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NAME                         NETWORK  DIRECTION  PRIORITY  ALLOW                         DENY  DISABLED
</span></span><span class="line"><span class="cl">gke-august-period-234610-all default  INGRESS    <span class="m">1000</span>      udp,icmp,esp,ah,sctp,tcp            False
</span></span></code></pre></div><p>Now, let&rsquo;s test again using 53/udp:</p>
<p>Pod on Node 2 (<code>10.24.12.41</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% nc -v -u 10.24.9.32 <span class="m">8888</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Exits with 0 and no output</span>
</span></span></code></pre></div><p>Pod on Node 1 (<code>10.24.9.32</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% tcpdump
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">21:54:39.787779 IP 10.24.12.41.40760 &gt; tmp-host-a.8888: UDP, length <span class="m">1</span>
</span></span><span class="line"><span class="cl">21:54:39.787802 IP tmp-host-a &gt; 10.24.12.41: ICMP tmp-host-a udp port <span class="m">8888</span> unreachable, length <span class="m">37</span>
</span></span><span class="line"><span class="cl">21:54:39.787805 IP 10.24.12.41.40760 &gt; tmp-host-a.8888: UDP, length <span class="m">1</span>
</span></span><span class="line"><span class="cl">21:54:39.787808 IP tmp-host-a &gt; 10.24.12.41: ICMP tmp-host-a udp port <span class="m">8888</span> unreachable, length <span class="m">37</span>
</span></span></code></pre></div><p>Yay! In the end, the issue was not so deep&hellip; A manual edit to the firewall rules that I had not thought through and for which I have no record of. I already terraformed a lot of the cluster and node creation, but I should definitely move everything to terraform and stop doing manual edits that can&rsquo;t be traced back!</p>
<!--
If you with to leave a comment, here is a Twitter thread:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I decided to write a blog post that recaps what I went through while trying to fix my cluster 😁 <a href="https://t.co/sb0UcctUUU">https://t.co/sb0UcctUUU</a></p>&mdash; Maël Valais (@maelvls) <a href="https://twitter.com/maelvls/status/1221488683485925376?ref_src=twsrc%5Etfw">January 26, 2020</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


-->

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/debug-kubernetes-networking/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
        
        <div style="float: right;">
            <p>Tags:
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/kubernetes/"> kubernetes </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/networking/"> networking </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
        </div>
        <div class="clearit"></div>
        
        
        
        
        
    </div></div>

</main><footer>
    
</footer></body>
</html>
