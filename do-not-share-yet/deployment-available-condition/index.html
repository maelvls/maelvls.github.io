<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.147.6">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="keywords" content="kubernetes,conditions"><meta name="description" content="Although the Kubernetes documentation is excellent, the API reference does not document the conditions that can be found in a deployment&#39;s status. The Available condition has always eluded me!"><meta property="og:url" content="https://maelvls.dev/do-not-share-yet/deployment-available-condition/">
  <meta property="og:site_name" content="maelvls dev blog">
  <meta property="og:title" content="Understanding the Available condition of a Kubernetes deployment">
  <meta property="og:description" content="Although the Kubernetes documentation is excellent, the API reference does not document the conditions that can be found in a deployment&#39;s status. The Available condition has always eluded me!">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="2020">
    <meta property="article:published_time" content="2020-07-07T16:33:55+02:00">
    <meta property="article:modified_time" content="2020-07-07T16:33:55+02:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Conditions">
    <meta property="og:image" content="https://maelvls.dev/do-not-share-yet/deployment-available-condition/cover-deployment-available-condition.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/deployment-available-condition/cover-deployment-available-condition.png">
  <meta name="twitter:title" content="Understanding the Available condition of a Kubernetes deployment">
  <meta name="twitter:description" content="Although the Kubernetes documentation is excellent, the API reference does not document the conditions that can be found in a deployment&#39;s status. The Available condition has always eluded me!">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Understanding the Available condition of a Kubernetes deployment | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://x.com/maelvls"><i title="X" class="icons fab fa-x"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">07</span>
                <span class="rest">
                    
                    Jul2020
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">Understanding the Available condition of a Kubernetes deployment</h1>
        </div>
        
        <span style="font-size: xx-small; text-align: right">
            cross-post <a href="https://dev.to/maelvls/understanding-the-available-condition-of-a-kubernetes-deployment-51li">
                <i title="Maël Valais's DEV Community Profile" class="icons fab fa-dev"></i>
            </a>
        </span>
        
    </div>
    <div class="markdown">
        <p>The various conditions that may appear in a deployment status are not documented in the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/">API reference</a>. For example, we can see what are the fields for <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#deploymentcondition-v1-apps">DeploymentConditions</a>, but it lacks the description of what conditions can appear in this field.</p>
<p>In this post, I dig into what the <code>Available</code> condition type is about and how it is computed.</p>
<p>Since the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/">API reference</a> does not contain any information about conditions, the only way to learn more is to dig into the Kubernetes codebase; quite deep into the code, <a href="https://github.com/kubernetes/kubernetes/blob/3615291/pkg/apis/apps/types.go#L461-L473">we can read some comments</a> about the three possible conditions for a deployment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Available means the deployment is available, ie. at least the minimum available</span>
</span></span><span class="line"><span class="cl"><span class="c1">// replicas required are up and running for at least minReadySeconds.</span>
</span></span><span class="line"><span class="cl"><span class="nx">DeploymentAvailable</span> <span class="nx">DeploymentConditionType</span> <span class="p">=</span> <span class="s">&#34;Available&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Progressing means the deployment is progressing. Progress for a deployment is</span>
</span></span><span class="line"><span class="cl"><span class="c1">// considered when a new replica set is created or adopted, and when new pods scale</span>
</span></span><span class="line"><span class="cl"><span class="c1">// up or old pods scale down. Progress is not estimated for paused deployments or</span>
</span></span><span class="line"><span class="cl"><span class="c1">// when progressDeadlineSeconds is not specified.</span>
</span></span><span class="line"><span class="cl"><span class="nx">DeploymentProgressing</span> <span class="nx">DeploymentConditionType</span> <span class="p">=</span> <span class="s">&#34;Progressing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ReplicaFailure is added in a deployment when one of its pods fails to be created</span>
</span></span><span class="line"><span class="cl"><span class="c1">// or deleted.</span>
</span></span><span class="line"><span class="cl"><span class="nx">DeploymentReplicaFailure</span> <span class="nx">DeploymentConditionType</span> <span class="p">=</span> <span class="s">&#34;ReplicaFailure&#34;</span>
</span></span></code></pre></div><p>The description given to the <code>Available</code> condition type is quite mysterious:</p>
<blockquote>
<p>At least the minimum available replicas required are up.</p></blockquote>
<p>What does &ldquo;minimum available replicas&rdquo; mean? Is this minimum 1? I cannot see any <code>minAvailable</code> field in the deployment spec, so my initial guess was that it would be 1.</p>
<p>Before going further, let&rsquo;s the description attached to the reason <a href="https://github.com/kubernetes/kubernetes/blob/3615291/pkg/controller/deployment/util/deployment_util.go#L96-L97"><code>MinimumReplicasAvailable</code></a>. Apparently, this reason is the only reason for the <code>Available</code> condition type.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// MinimumReplicasAvailable is added in a deployment when it has its minimum</span>
</span></span><span class="line"><span class="cl"><span class="c1">// replicas required available.</span>
</span></span><span class="line"><span class="cl"><span class="nx">MinimumReplicasAvailable</span> <span class="p">=</span> <span class="s">&#34;MinimumReplicasAvailable&#34;</span>
</span></span></code></pre></div><p>The description doesn&rsquo;t help either. Let&rsquo;s see what the <a href="https://github.com/kubernetes/kubernetes/blob/3615291/pkg/controller/deployment/sync.go#L513-L516">deployment sync</a> function does:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">availableReplicas</span> <span class="o">+</span> <span class="nx">deploy</span><span class="p">.</span><span class="nf">MaxUnavailable</span><span class="p">(</span><span class="nx">deployment</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">minAvailability</span> <span class="o">:=</span> <span class="nx">deploy</span><span class="p">.</span><span class="nf">NewCondition</span><span class="p">(</span><span class="s">&#34;Available&#34;</span><span class="p">,</span> <span class="s">&#34;True&#34;</span><span class="p">,</span> <span class="s">&#34;MinimumReplicasAvailable&#34;</span><span class="p">,</span> <span class="s">&#34;Deployment has minimum availability.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">deploy</span><span class="p">.</span><span class="nf">SetCondition</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">status</span><span class="p">,</span> <span class="o">*</span><span class="nx">minAvailability</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>Note: in the real code, the max unavailable is on the right side of the inequality. I find it easier to reason about this inequality when the single value to the right is the desired replica number.</p></blockquote>
<p>Ahhh, the actual logic being <code>Available</code>! If <code>maxUnavailable</code> is 0, then it becomes obvious: the &ldquo;minimum availability&rdquo; means that number of available replicas is greater or equal to the number of replicas in the spec; the deployment has minimum availability if and only if the following inequality holds:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">available</th>
          <th style="text-align: center">+</th>
          <th style="text-align: center">acceptable unavailable</th>
          <th style="text-align: center">≥</th>
          <th style="text-align: center">desired</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">1️⃣</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">2️⃣</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">3️⃣</td>
      </tr>
  </tbody>
</table>
<p>Let&rsquo;s take an example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c"># 3️⃣ desired</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 2️⃣ acceptable unavailable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">availableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="c"># 1️⃣ available</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Available&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span></code></pre></div><p>In this example, the inequality holds which means this deployment has &ldquo;minimum availability&rdquo; (= <code>Available = True</code>):</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><code>availableReplicas</code></th>
          <th style="text-align: center">+</th>
          <th style="text-align: center"><code>maxUnavailable</code></th>
          <th style="text-align: center">≥</th>
          <th style="text-align: center"><code>replicas</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">8</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">2</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">10</td>
      </tr>
  </tbody>
</table>
<h2 id="default-value-for-maxunavailable-is-25">Default value for <code>maxUnavailable</code> is 25%</h2>
<p>Now, what happens when <code>maxUnavailable</code> is not set? The official documentation <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#max-unavailable">maxUnavailable</a> says:</p>
<blockquote>
<p><code>maxUnavailable</code> is an optional field that specifies the maximum number of Pods that can be unavailable during the update process. The value can be an absolute number (for example, 5) or a percentage of desired Pods (for example, 10%). The absolute number is calculated from percentage by rounding down. The value cannot be 0 if <code>maxSurge</code> is 0. <strong>The default value is 25%</strong>.</p>
<p>For example, when this value is set to 30%, the old ReplicaSet can be scaled down to 70% of desired Pods immediately when the rolling update starts. Once new Pods are ready, old ReplicaSet can be scaled down further, followed by scaling up the new ReplicaSet, ensuring that the total number of Pods available at all times during the update is at least 70% of the desired Pods.</p></blockquote>
<p>Let&rsquo;s take an example with a deployment that has no <code>maxUnavailable</code> field set, and imagine that 4 pods are unavailable due to a resource quota that only allows for 5 pods to start:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">availableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">unavailableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Available&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span></code></pre></div><p>This time, the inequality does not hold:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: right"><code>status.availableReplicas</code></th>
          <th style="text-align: center">+</th>
          <th style="text-align: center"><code>spec.strategy.rollingUpdate.maxUnavailable</code></th>
          <th style="text-align: center">≱</th>
          <th style="text-align: center"><code>spec.replicas</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: right">5</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">lower(25% * 10) = 2</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">10</td>
      </tr>
  </tbody>
</table>
<p>Let&rsquo;s dig a bit more and see how <a href="https://github.com/kubernetes/kubernetes/blob/3615291/pkg/controller/deployment/util/deployment_util.go#L434-L445"><code>MaxAvailable</code></a> is defined:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// MaxUnavailable returns the maximum unavailable pods a rolling deployment</span>
</span></span><span class="line"><span class="cl"><span class="c1">// can take.</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MaxUnavailable</span><span class="p">(</span><span class="nx">deployment</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nf">IsRollingUpdate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">deployment</span><span class="p">)</span> <span class="o">||</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">maxUnavailable</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">ResolveFenceposts</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">RollingUpdate</span><span class="p">.</span><span class="nx">MaxSurge</span><span class="p">,</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">RollingUpdate</span><span class="p">.</span><span class="nx">MaxUnavailable</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">maxUnavailable</span> <span class="p">&gt;</span> <span class="o">*</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">*</span><span class="nx">deployment</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">maxUnavailable</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The core of the logic behind maxUnavailable is in <a href="https://github.com/kubernetes/kubernetes/blob/3615291/pkg/controller/deployment/util/deployment_util.go#L874-L902"><code>ResolveFenceposts</code></a> (note: I simplified the code a bit to make it more readable):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ResolveFenceposts resolves both maxSurge and maxUnavailable. This needs to happen in one</span>
</span></span><span class="line"><span class="cl"><span class="c1">// step. For example:</span>
</span></span><span class="line"><span class="cl"><span class="c1">//</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2 desired, max unavailable 1%, surge 0% - should scale old(-1), then new(+1), then old(-1), then new(+1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 1 desired, max unavailable 1%, surge 0% - should scale old(-1), then new(+1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2 desired, max unavailable 25%, surge 1% - should scale new(+1), then old(-1), then new(+1), then old(-1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 1 desired, max unavailable 25%, surge 1% - should scale new(+1), then old(-1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2 desired, max unavailable 0%, surge 1% - should scale new(+1), then old(-1), then new(+1), then old(-1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 1 desired, max unavailable 0%, surge 1% - should scale new(+1), then old(-1)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ResolveFenceposts</span><span class="p">(</span><span class="nx">maxSurge</span><span class="p">,</span> <span class="nx">maxUnavailable</span> <span class="o">*</span><span class="nx">instr</span><span class="p">.</span><span class="nx">IntOrString</span><span class="p">,</span> <span class="nx">desired</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">surge</span><span class="p">,</span> <span class="nx">_</span>       <span class="o">:=</span> <span class="nx">instr</span><span class="p">.</span><span class="nf">GetValueFromIntOrPercent</span><span class="p">(</span><span class="nx">instr</span><span class="p">.</span><span class="nf">ValueOrDefault</span><span class="p">(</span><span class="nx">maxSurge</span><span class="p">,</span> <span class="nx">instr</span><span class="p">.</span><span class="nf">FromInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="nx">desired</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">unavailable</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">instr</span><span class="p">.</span><span class="nf">GetValueFromIntOrPercent</span><span class="p">(</span><span class="nx">instr</span><span class="p">.</span><span class="nf">ValueOrDefault</span><span class="p">(</span><span class="nx">maxUnavailable</span><span class="p">,</span> <span class="nx">instr</span><span class="p">.</span><span class="nf">FromInt</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="nx">desired</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">surge</span><span class="p">,</span> <span class="nx">unavailable</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>false</code> boolean turns the integer rounding &ldquo;up&rdquo;, which means <code>0.5</code> will be rounded to <code>0</code> instead of <code>1</code>.</p>
<p>The <code>maxUnavailable</code> and <code>maxSurge</code> (they call them &ldquo;fenceposts&rdquo; values) are simply read from the deployment&rsquo;s spec. In the following example, the deployment will become <code>Available = True</code> only if there are at least 5 replicas available:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="l">%</span><span class="w"> </span><span class="c"># 🔰 10 * 0.0 = 0 replicas</span><span class="w">
</span></span></span></code></pre></div><h2 id="hands-on-example-with-the-available-condition">Hands-on example with the <code>Available</code> condition</h2>
<p>Imagine that we have a namespace named <code>restricted</code> that only allows for 200 MiB, and our pod requires 50 MiB. The first 4 pods will be successfully created, but the fifth one will fail.</p>
<p>Let us first apply the following manifest:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ResourceQuota</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mem-cpu-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hard</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="l">200Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">restricted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c"># 🔰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50Mi&#34;</span><span class="w"> </span><span class="c"># the 5th pod will fail (on purpose)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>After a few seconds, the <code>Available</code> condition stabilizes to <code>False</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># kubectl -n restricted get deploy test -oyaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c"># 🔰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:27Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:27Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment does not have minimum availability.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">MinimumReplicasUnavailable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Available</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:27Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:27Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;pods &#34;test-7df57bd99d-5qw47&#34; is forbidden: exceeded quota: mem-cpu-demo, requested: requests.memory=50Mi, used: requests.memory=200Mi, limited: requests.memory=200Mi&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">FailedCreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:27Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-07-07T14:04:38Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet &#34;test-7df57bd99d&#34; is progressing.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSetUpdated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Progressing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">availableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">readyReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">unavailableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">updatedReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span></code></pre></div><p>We are asking for at most 0 unavailable replicas and there is 1 unavailable replica (due to the resource quota). Thus, the &ldquo;minimum availability&rdquo; inequality does not hold which means the deployment has the condition <code>Available = False</code>:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><code>availableReplicas</code></th>
          <th style="text-align: center">+</th>
          <th style="text-align: center"><code>rollingUpdate.maxUnavailable</code></th>
          <th style="text-align: center">≱</th>
          <th style="text-align: center"><code>replicas</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">4</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">0</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">5</td>
      </tr>
  </tbody>
</table>
<p><strong>Update 9 July 2020:</strong> added a paragraph on the default value for <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#max-unavailable">maxUnavailable</a>, and fixed the yaml example where I had mixed <code>unavailableReplicas</code> with <code>maxUnavailable</code>.</p>

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2020/deployment-available-condition/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
        
        <div style="float: right;">
            <p>Tags:
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/conditions/"> conditions </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <a href="/tags/kubernetes/"> kubernetes </a>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                
        </div>
        <div class="clearit"></div>
        
        
        
        
        
    </div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>
    
</footer></body>
</html>
