<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.75.1" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="Maël Valais"><meta name="description" content=""><meta property="og:title" content="Wireshark Debug Mitmproxy" />
<meta property="og:description" content="When using mitmproxy, I hit an issue with vcert: the vcert HTTP requests would not be responded to with mitmproxy in-between.
 10.132.0.13 = the TPP instance IP, 35.235.243.226 = the iap proxy IP.  Using a direct connection (vcert -&gt; iap proxy -&gt; tpp instance), the HTTP request succeeds:
35.235.243.226 -&gt; 10.132.0.13 TCP 74 46011 → 443 [SYN] Seq=0 Win=65535 Len=0 MSS=1420 SACK_PERM=1 TSval=2496652920 TSecr=0 WS=256 10.132.0.13 -&gt; 35.235.243.226 TCP 74 443 → 46011 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1420 WS=256 SACK_PERM=1 TSval=3076143986 TSecr=2496652920 35." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/wireshark-debug-mitmproxy/" />
<meta property="og:image" content="https://maelvls.dev/do-not-share-yet/wireshark-debug-mitmproxy/disable-client-certs.png" />
<meta property="article:published_time" content="2021-09-17T10:31:09+02:00" />
<meta property="article:modified_time" content="2021-09-17T10:31:09+02:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://maelvls.dev/do-not-share-yet/wireshark-debug-mitmproxy/disable-client-certs.png"/>

<meta name="twitter:title" content="Wireshark Debug Mitmproxy"/>
<meta name="twitter:description" content="When using mitmproxy, I hit an issue with vcert: the vcert HTTP requests would not be responded to with mitmproxy in-between.
 10.132.0.13 = the TPP instance IP, 35.235.243.226 = the iap proxy IP.  Using a direct connection (vcert -&gt; iap proxy -&gt; tpp instance), the HTTP request succeeds:
35.235.243.226 -&gt; 10.132.0.13 TCP 74 46011 → 443 [SYN] Seq=0 Win=65535 Len=0 MSS=1420 SACK_PERM=1 TSval=2496652920 TSecr=0 WS=256 10.132.0.13 -&gt; 35.235.243.226 TCP 74 443 → 46011 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1420 WS=256 SACK_PERM=1 TSval=3076143986 TSecr=2496652920 35."/>
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Wireshark Debug Mitmproxy | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about/">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li><li><a href="https://dev.to/maelvls"><i title="Maël Valais&#39;s DEV Community Profile" class="icons fab fa-dev"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
    <div class="author">
        
    </div>
    <div class="post-header">
        
        <div class="meta">
            <div class="date">
                <span class="day">17</span>
                <span class="rest">
                    
                    Sep2021
                    
                </span>
            </div>
        </div>
        
        <div class="matter">
            <h1 class="title">Wireshark Debug Mitmproxy</h1>
        </div>
        
    </div>
    <div class="markdown">
        <p>When using mitmproxy, I hit an issue with vcert: the vcert HTTP requests would
not be responded to with mitmproxy in-between.</p>
<ul>
<li>10.132.0.13 = the TPP instance IP,</li>
<li>35.235.243.226 = the iap proxy IP.</li>
</ul>
<p>Using a direct connection (vcert -&gt; iap proxy -&gt; tpp instance), the HTTP request
succeeds:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">             35.235.243.226    -&gt;    10.132.0.13      TCP         74      46011 → 443 [SYN] Seq=0 Win=65535 Len=0 MSS=1420 SACK_PERM=1 TSval=2496652920 TSecr=0 WS=256
             10.132.0.13       -&gt;    35.235.243.226   TCP         74      443 → 46011 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1420 WS=256 SACK_PERM=1 TSval=3076143986 TSecr=2496652920
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=1 Ack=1 Win=65536 Len=0 TSval=2496652920 TSecr=3076143986
             35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     354     Client Hello
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     3474    Server Hello, Certificate, Certificate Status, Server Key Exchange, Server Hello Done
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=289 Ack=3409 Win=72448 Len=0 TSval=2496652960 TSecr=3076144026
             35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     159     Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     117     Change Cipher Spec, Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=382 Ack=3460 Win=72448 Len=0 TSval=2496653021 TSecr=3076144087
    request  35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     470     Application Data
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     99      Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=786 Ack=3493 Win=72448 Len=0 TSval=2496653053 TSecr=3076144114
   1st diff  35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     390     Encrypted Handshake Message
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     3552    Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=1110 Ack=6979 Win=79360 Len=0 TSval=2496653076 TSecr=3076144142
tls renego?  35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     243     Encrypted Handshake Message, Encrypted Handshake Message, Change Cipher Spec, Encrypted Handshake Message
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     141     Change Cipher Spec, Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [ACK] Seq=1287 Ack=7054 Win=79360 Len=0 TSval=2496653109 TSecr=3076144170
   response  10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     704     Application Data
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      46011 → 443 [FIN, ACK] Seq=1287 Ack=7693 Win=82176 Len=0 TSval=2496653497 TSecr=3076144562
             10.132.0.13       -&gt;    35.235.243.226   TCP         66      443 → 46011 [ACK] Seq=7693 Ack=1288 Win=2105344 Len=0 TSval=3076144563 TSecr=2496653497
</code></pre></div><p>Using mitmproxy in between (vcert -&gt; mitmproxy -&gt; iap proxy -&gt; tpp instance),
the HTTP request is correctly sent and aknowledged, but hangs after that:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">             35.235.243.226    -&gt;    10.132.0.13      TCP         74      37677 → 443 [SYN] Seq=0 Win=65535 Len=0 MSS=1420 SACK_PERM=1 TSval=2496784362 TSecr=0 WS=256
             10.132.0.13       -&gt;    35.235.243.226   TCP         74      443 → 37677 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1420 WS=256 SACK_PERM=1 TSval=3076275429 TSecr=2496784362
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      37677 → 443 [ACK] Seq=1 Ack=1 Win=65536 Len=0 TSval=2496784362 TSecr=3076275429
             35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     396     Client Hello
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     2963    Server Hello, Certificate, Server Key Exchange, Server Hello Done
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      37677 → 443 [ACK] Seq=331 Ack=2898 Win=71424 Len=0 TSval=2496784400 TSecr=3076275468
             35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     159     Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     117     Change Cipher Spec, Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      37677 → 443 [ACK] Seq=424 Ack=2949 Win=71424 Len=0 TSval=2496784432 TSecr=3076275494
    request  35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     333     Application Data
    request  35.235.243.226    -&gt;    10.132.0.13      TLSv1.2     230     Application Data
             10.132.0.13       -&gt;    35.235.243.226   TCP         66      443 → 37677 [ACK] Seq=2949 Ack=855 Win=2105856 Len=0 TSval=3076275545 TSecr=2496784477
             10.132.0.13       -&gt;    35.235.243.226   TLSv1.2     99      Encrypted Handshake Message
             35.235.243.226    -&gt;    10.132.0.13      TCP         66      37677 → 443 [ACK] Seq=855 Ack=2982 Win=71424 Len=0 TSval=2496784478 TSecr=3076275545
</code></pre></div><p>You can see the full PCAP traces by downloading
<a href="vcert-with-and-without-mitmproxy-through-iap.pcapng">vcert-with-and-without-mitmproxy-through-iap.pcapng</a>.</p>
<p>The difference between both TLS flows seemed to be the second <code>Change Cipher Spec</code> that happens in the first flow (without mitmproxy). I knew from previous
experiment that our TPP instance was using TLS renegociation whenever the
VEDAuth IIS endpoint&rsquo;s SSL &ldquo;Client Certificate&rdquo; was set to &ldquo;Accept&rdquo;. This
behavior is detailed in the vcert issue <a href="https://github.com/Venafi/vcert/issues/148">Venafi Issuer error when configuring
cert-manager. &ldquo;local error: tls: no
renegotiation&rdquo;</a>.</p>
<p>And sure enough, disabling the client certificate option worked! After switching
the option from &ldquo;Accept&rdquo; to &ldquo;Disable&rdquo;, vcert with mitmproxy started working!</p>
<p><img src="disable-client-certs.png" alt=""></p>

    </div>
    <a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/2021/wireshark-debug-mitmproxy/index.md">📝 Edit this page</a>
    <div class="tags">
        
        
        
        
        
        
        
        
        
    </div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="💬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
