<!DOCTYPE html>
<html lang="en"><head>

  <meta name="generator" content="Hugo 0.64.0" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="MaÃ«l Valais"><meta property="og:title" content="Some kubectl stuff" />
<meta property="og:description" content="kubectl run --generator=run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash gcloud ssh ... docker ps --format=&#39;{{.ID}} {{.Names}}&#39; kubectl run --generator=run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash sudo iptables-save &gt; a &amp;&amp; vim a &amp;&amp; sudo iptables-restore &lt; a % mvalais@gke-august-period-micro-g961 ~ $ vmstat -SM 1 10 procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- r b swpd free buff cache si so bi bo in cs us sy id wa st 0 0 0 104 7 218 0 0 160 57 273 760 2 1 96 1 0 k get pods -A --field-selector=spec." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maelvls.dev/do-not-share-yet/notes/kubectl/" />
<meta property="article:published_time" content="2019-01-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-01-03T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Some kubectl stuff"/>
<meta name="twitter:description" content="kubectl run --generator=run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash gcloud ssh ... docker ps --format=&#39;{{.ID}} {{.Names}}&#39; kubectl run --generator=run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash sudo iptables-save &gt; a &amp;&amp; vim a &amp;&amp; sudo iptables-restore &lt; a % mvalais@gke-august-period-micro-g961 ~ $ vmstat -SM 1 10 procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- r b swpd free buff cache si so bi bo in cs us sy id wa st 0 0 0 104 7 218 0 0 160 57 273 760 2 1 96 1 0 k get pods -A --field-selector=spec."/>

  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/normalize.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/main.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/all.css" />
<link rel="stylesheet" type="text/css" media="screen" href="https://maelvls.dev/do-not-share-yet/css/maelvls.css" /><title>Some kubectl stuff | maelvls dev blog</title></head>
<body>

<header>

  <div id="avatar">
    <a href="https://maelvls.dev/do-not-share-yet/">
      <img src="/img/mael.jpg" alt="maelvls dev blog">
    </a>
  </div>

  <div id="titletext"><h2 id="title"><a href="https://maelvls.dev/do-not-share-yet/">maelvls dev blog</a></h2></div>
  <div id="title-description"><p id="subtitle">Systems software engineer. I write mostly about Kubernetes and Go. <a href="/about">About</a></p><div id=social>
    <nav>
      <ul><li><a href="https://github.com/maelvls"><i title="Github" class="icons fab fa-github"></i></a></li><li><a href="https://twitter.com/maelvls"><i title="Twitter" class="icons fab fa-twitter"></i></a></li></ul>
    </nav>
  </div>
  </div>
  <div id="mainmenu">
	
  </div>
</header>
<main><div class="post">
<div class="author">

</div>
<div class="post-header">

<div class="meta">
<div class="date">
<span class="day">03</span>
<span class="rest">Jan 2019</span>
</div>
</div>

<div class="matter">
<h1 class="title">Some kubectl stuff</h1>
</div>
</div>
<div class="markdown">
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">gcloud ssh ...
docker ps --format<span class="o">=</span><span class="s1">&#39;{{.ID}} {{.Names}}&#39;</span>
kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash
sudo iptables-save &gt; a <span class="o">&amp;&amp;</span> vim a <span class="o">&amp;&amp;</span> sudo iptables-restore &lt; a
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% mvalais@gke-august-period-micro-g961 ~ $ vmstat -SM <span class="m">1</span> <span class="m">10</span>
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 <span class="m">0</span>  <span class="m">0</span>      <span class="m">0</span>    <span class="m">104</span>      <span class="m">7</span>    <span class="m">218</span>    <span class="m">0</span>    <span class="m">0</span>   <span class="m">160</span>    <span class="m">57</span>  <span class="m">273</span>  <span class="m">760</span>  <span class="m">2</span>  <span class="m">1</span> <span class="m">96</span>  <span class="m">1</span>  <span class="m">0</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">k get pods -A --field-selector<span class="o">=</span>spec.nodeName<span class="o">=</span>gke-august-period-234610-worker-micro-1de60498-g961
gcloud compute ssh gke-august-period-234610-worker-micro-1de60498-g961 --zone<span class="o">=</span>us-east1-c --command <span class="s2">&#34;docker run --rm --net=host corfr/tcpdump -i cbr0 -U -w - &#39;not port 22&#39;&#34;</span> <span class="p">|</span> wireshark -k -i -
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">dmsg
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="c1"># Host B is 10.142.15.201</span>
<span class="c1"># Doesn&#39;t work:</span>
<span class="c1">#   from the pod on host B, nslookup github.com (tcpdump on pod&#39;s eth0)</span>
<span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span>      <span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>    <span class="n">DNS</span> <span class="m">98</span> <span class="n">Standard</span> <span class="n">query</span>            <span class="n">A</span> <span class="n">github.com.traefik.svc.cluster.local</span>
<span class="c1">#   same from host&#39;s eth0</span>
<span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span>      <span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>       <span class="n">DNS</span> <span class="m">96</span> <span class="n">Standard</span> <span class="n">query</span>            <span class="n">A</span> <span class="n">github.com.traefik.svc.cluster.local</span>

<span class="c1"># Works:</span>
<span class="c1">#   from the host B, nslookup github.com 10.27.240.10 (tcpdump on host&#39;s eth0)</span>
<span class="m">10.142</span><span class="m">.15</span><span class="m">.201</span>   <span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>       <span class="n">DNS</span> <span class="m">70</span> <span class="n">Standard</span> <span class="n">query</span>            <span class="n">A</span> <span class="n">github.com</span>
<span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>       <span class="m">10.142</span><span class="m">.15</span><span class="m">.201</span>   <span class="n">DNS</span> <span class="m">86</span> <span class="n">Standard</span> <span class="n">query</span> <span class="n">response</span>   <span class="n">A</span> <span class="n">github.com</span> <span class="n">A</span> <span class="m">140.82</span><span class="m">.113</span><span class="m">.4</span>
</code></pre></div><p>Dumping iptables on host B:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% gcloud compute ssh gke-august-period-234610-worker-micro-1de60498-g961 --zone<span class="o">=</span>us-east1-c --command <span class="s2">&#34;docker run --rm --net=host --privileged praqma/network-multitool iptables-save&#34;</span> <span class="p">|</span> pbcopy
-A KUBE-HP-JSWHQ3CPP5EMKPCA -s 10.24.10.2/32 -m comment --comment <span class="s2">&#34;akrobateo-traefik-pqkqf_traefik hostport 443&#34;</span> -j KUBE-MARK-MASQ
-A KUBE-HP-JSWHQ3CPP5EMKPCA -p tcp -m comment --comment <span class="s2">&#34;akrobateo-traefik-pqkqf_traefik hostport 443&#34;</span> -m tcp -j DNAT --to-destination 10.24.10.2:443
-A KUBE-HP-Q34NV5ACWTD24LGG -s 10.24.10.2/32 -m comment --comment <span class="s2">&#34;akrobateo-traefik-pqkqf_traefik hostport 80&#34;</span> -j KUBE-MARK-MASQ
-A KUBE-HP-Q34NV5ACWTD24LGG -p tcp -m comment --comment <span class="s2">&#34;akrobateo-traefik-pqkqf_traefik hostport 80&#34;</span> -m tcp -j DNAT --to-destination 10.24.10.2:80
</code></pre></div><p>Contrack:</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="c1"># From the container. Since orig dst != reply src, packet is DNAT.</span>
<span class="o">% nslookup github.com
</span><span class="o">%</span> <span class="n">mvalais</span><span class="o">@</span><span class="n">gke</span><span class="o">-</span><span class="n">august</span><span class="o">-</span><span class="n">period</span><span class="m">-234610</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="n">micro</span><span class="m">-1</span><span class="n">de60498</span><span class="o">-</span><span class="n">g961</span> <span class="o">~</span> <span class="o">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="o">-</span><span class="n">net</span><span class="o">=</span><span class="n">host</span> <span class="o">-</span><span class="o">-</span><span class="n">privileged</span> <span class="o">-</span><span class="o">-</span><span class="n">rm</span> <span class="n">missioncriticalkubernetes</span><span class="o">/</span><span class="n">conntrack</span> <span class="o">-</span><span class="n">L</span> <span class="o">|</span> <span class="n">grep</span> <span class="m">10.24</span>
<span class="n">conntrack</span> <span class="nf">v1.4.4 </span><span class="p">(</span><span class="n">conntrack</span><span class="o">-</span><span class="n">tools</span><span class="p">)</span><span class="o">:</span> <span class="m">52</span> <span class="n">flow</span> <span class="n">entries</span> <span class="n">have</span> <span class="n">been</span> <span class="n">shown.</span>
<span class="n">udp</span> <span class="m">17</span> <span class="m">26</span>  <span class="n">src</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span>    <span class="n">dst</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">sport</span><span class="o">=</span><span class="m">57400</span> <span class="n">dport</span><span class="o">=</span><span class="m">53</span> <span class="n">[UNREPLIED</span><span class="n">]</span> <span class="n">src</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span>     <span class="n">sport</span><span class="o">=</span><span class="m">53</span> <span class="n">dport</span><span class="o">=</span><span class="m">57400</span>           <span class="n">mark</span><span class="o">=</span><span class="m">0</span> <span class="n">use</span><span class="o">=</span><span class="m">1</span>
<span class="c1"># From host B. Since orig dst != reply src, packet is DNAT.</span>
<span class="o">% nslookup github.com 10.27.240.10
</span><span class="o">%</span> <span class="n">mvalais</span><span class="o">@</span><span class="n">gke</span><span class="o">-</span><span class="n">august</span><span class="o">-</span><span class="n">period</span><span class="m">-234610</span><span class="o">-</span><span class="n">worker</span><span class="o">-</span><span class="n">micro</span><span class="m">-1</span><span class="n">de60498</span><span class="o">-</span><span class="n">g961</span> <span class="o">~</span> <span class="o">$</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="o">-</span><span class="n">net</span><span class="o">=</span><span class="n">host</span> <span class="o">-</span><span class="o">-</span><span class="n">privileged</span> <span class="o">-</span><span class="o">-</span><span class="n">rm</span> <span class="n">missioncriticalkubernetes</span><span class="o">/</span><span class="n">conntrack</span> <span class="o">-</span><span class="n">L</span> <span class="o">|</span> <span class="n">grep</span> <span class="m">10.24</span>
<span class="n">udp</span> <span class="m">17</span> <span class="m">175</span> <span class="n">src</span><span class="o">=</span><span class="m">10.142</span><span class="m">.15</span><span class="m">.201</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">sport</span><span class="o">=</span><span class="m">37337</span> <span class="n">dport</span><span class="o">=</span><span class="m">53</span>             <span class="n">src</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.26</span> <span class="n">dst</span><span class="o">=</span><span class="m">10.142</span><span class="m">.15</span><span class="m">.201</span> <span class="n">sport</span><span class="o">=</span><span class="m">53</span> <span class="n">dport</span><span class="o">=</span><span class="m">37337</span> <span class="n">[ASSURED</span><span class="n">]</span> <span class="n">mark</span><span class="o">=</span><span class="m">0</span> <span class="n">use</span><span class="o">=</span><span class="m">1</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">mvalais@gke-august-period-234610-worker-micro-1de60498-g961 ~ $ docker run -it --rm --net<span class="o">=</span>host praqma/network-multitool ip route
default via 10.142.0.1 dev eth0    proto dhcp                src 10.142.15.201 metric <span class="m">1024</span>
default via 10.142.0.1 dev eth0    proto dhcp                                  metric <span class="m">1024</span>
10.24.10.0/24          dev cbr0    proto kernel scope link   src 10.24.10.1
10.142.0.1             dev eth0    proto dhcp scope   link   src 10.142.15.201 metric <span class="m">1024</span>
10.142.0.1             dev eth0    proto dhcp scope   link                     metric <span class="m">1024</span>
169.254.123.0/24       dev docker0 proto kernel scope link   src 169.254.123.1 linkdown
</code></pre></div><p>What&rsquo;s very weird is that ICMP packets are properly routed:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% mvalais@gke-august-period-234610-worker-micro-1de60498-g961 ~ $ docker run --rm -it --net<span class="o">=</span>container:9e557d74b06c praqma/network-multitool bash
% bash-5.0# ping 10.24.9.3
PING 10.24.9.3 <span class="o">(</span>10.24.9.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.24.9.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>1.47 ms

% bash-5.0# nc -v 10.24.9.21 <span class="m">9000</span>
</code></pre></div><p>Let&rsquo;s take another pod that is on host A. It&rsquo;s minio, which serves on port
10.24.9.21:9000:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">bash-5.0# ping 10.24.9.21
PING 10.24.9.21 <span class="o">(</span>10.24.9.21<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from 10.24.9.21: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>1.16 ms

% bash-5.0# nc -v 10.24.9.21 <span class="m">9000</span>
</code></pre></div><p>Then I found out that host B has a &lsquo;stale kube dns&rsquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">mvalais@gke-august-period-234610-worker-micro-1de60498-g961 ~ $ tail /var/log/kube-proxy.log
I0125 12:30:37.882376       <span class="m">1</span> service.go:334<span class="o">]</span> Updating existing service port <span class="s2">&#34;traefik/traefik:http&#34;</span> at 10.27.244.111:80/TCP
I0125 12:31:35.093785       <span class="m">1</span> proxier.go:675<span class="o">]</span> Stale udp service kube-system/kube-dns:dns -&gt; 10.27.240.10
</code></pre></div><p>Now, let&rsquo;s trace in iptables on host B:
<a href="https://www.opsist.com/blog/2015/08/11/how-do-i-see-what-iptables-is-doing.html">https://www.opsist.com/blog/2015/08/11/how-do-i-see-what-iptables-is-doing.html</a></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% sudo iptables -t nat -I PREROUTING <span class="m">1</span> -j LOG
% sudo iptables -t nat -I POSTROUTING <span class="m">1</span> -j LOG
% sudo iptables -t nat -I OUTPUT <span class="m">1</span> -j LOG
% demsg -w
<span class="o">[</span>89712.445268<span class="o">]</span>                                                 <span class="nv">IN</span><span class="o">=</span>cbr0 <span class="nv">OUT</span><span class="o">=</span>                                                     <span class="nv">PHYSILEN</span><span class="o">=</span><span class="m">82</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">38810</span> <span class="nv">PROTO</span><span class="o">=</span>UDP <span class="nv">SPT</span><span class="o">=</span><span class="m">54407</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">53</span> <span class="nv">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="o">[</span>89712.463153<span class="o">]</span>                                                 <span class="nv">IN</span><span class="o">=</span>cbr0 <span class="nv">OUT</span><span class="o">=</span>                                                     <span class="nv">PHYSILEN</span><span class="o">=</span><span class="m">82</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">38810</span> <span class="nv">PROTO</span><span class="o">=</span>UDP <span class="nv">SPT</span><span class="o">=</span><span class="m">54407</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">53</span> <span class="nv">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="o">[</span>89712.481021<span class="o">]</span>                                                 <span class="nv">IN</span><span class="o">=</span>cbr0 <span class="nv">OUT</span><span class="o">=</span>                                                     <span class="nv">PHYSILEN</span><span class="o">=</span><span class="m">82</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">64</span> <span class="nv">ID</span><span class="o">=</span><span class="m">38810</span> <span class="nv">PROTO</span><span class="o">=</span>UDP <span class="nv">SPT</span><span class="o">=</span><span class="m">54407</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">53</span> <span class="nv">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="o">[</span>89712.498895<span class="o">]</span> <span class="nv">IN</span><span class="o">=</span> <span class="nv">OUT</span><span class="o">=</span>eth0                                                     <span class="nv">PHYSIN</span><span class="o">=</span>veth4a3719bc <span class="nv">SRC</span><span class="o">=</span>10.24.10.2 <span class="nv">DST</span><span class="o">=</span>10.24.9.10    <span class="nv">LEN</span><span class="o">=</span><span class="m">82</span> <span class="nv">TOS</span><span class="o">=</span>0x00 <span class="nv">PREC</span><span class="o">=</span>0x00 <span class="nv">TTL</span><span class="o">=</span><span class="m">63</span> <span class="nv">ID</span><span class="o">=</span><span class="m">38810</span> <span class="nv">PROTO</span><span class="o">=</span>UDP <span class="nv">SPT</span><span class="o">=</span><span class="m">54407</span> <span class="nv">DPT</span><span class="o">=</span><span class="m">53</span> <span class="nv">LEN</span><span class="o">=</span><span class="m">62</span>
</code></pre></div><p>Let&rsquo;s try again with the TRACE module:</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="o">% sudo modprobe ipt_LOG
</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">I</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="m">10.24</span><span class="m">.0</span><span class="m">.0</span><span class="o">/</span><span class="m">16</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
<span class="o">% docker run --rm -it --net=container:9e557d74b06c --privileged praqma/network-multitool nslookup github.com
</span><span class="o">%</span> <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
<span class="n">[90332.179725</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">raw</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">2</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.200327</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>               <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.221171</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.241576</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">14</span>                <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.262385</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SVC</span><span class="o">-</span><span class="n">TCOU7JCQXEZGVUNU</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.284116</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SEP</span><span class="o">-</span><span class="n">MQYG7Z5PYI3N6YFY</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span>  <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.305838</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.326491</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.346973</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">4</span>             <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.368068</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.389031</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">1</span>            <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.410253</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">3</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.430735</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">USER</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.451887</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">4</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.472366</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">ISOLATION</span><span class="o">-</span><span class="n">STAGE</span><span class="m">-1</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">2</span> <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.494488</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">10</span>                   <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.515049</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.531693</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.547953</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">2</span>            <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.564769</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.580978</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">IP</span><span class="o">-</span><span class="n">MASQ</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                       <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[90332.596840</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">4</span>                 <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth4a3719bc</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.10</span><span class="m">.2</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.3</span>     <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">43592</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">36775</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</code></pre></div><p>Note that using TRACE is extremely expensive. For example, using <code>-p icmp</code>
would result in pings going from 1ms (without tracing) to 500ms. I also
overloaded one of the nodes by adding a rule that was &ldquo;too wide&rdquo; and nearly
killed the entire node. Use tracing filters (<code>-s</code>, <code>-p</code>, <code>-d</code>) as narrow as
possible!</p>
<h2 id="other-experiment-icmp">Other experiment: icmp</h2>
<p>At this point, I recreated both nodes which changed all the IP CIDRs.</p>
<ul>
<li>Host A CIDR is <code>10.24.9.0/24</code>,</li>
<li>Host B CIDR is <code>10.24.11.0/24</code>,</li>
<li>We use the traefik pod (<code>10.24.11.7</code>) on host B for reproducing the
connectivity issue.</li>
<li>KubeDNS is running on <code>10.24.9.14</code>.</li>
</ul>
<p>Host B:</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="o">% docker run --rm -it --net=container:$(docker ps | grep POD_traefik | head -1 | cut -f1 -d&#39; &#39;) --privileged praqma/network-multitool ping 10.24.9.14
</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">s</span> <span class="m">10.24</span><span class="m">.11</span><span class="m">.0</span><span class="o">/</span><span class="m">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
<span class="o">% sudo iptables -A PREROUTING -p icmp -t raw -d 10.24.11.0/24 -j TRACE
</span><span class="o">%</span> <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
<span class="n">[</span> <span class="m">5365.769471</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">raw</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">5</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5365.790765</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5365.812684</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5365.834225</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>       <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5365.855880</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5365.877624</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span> <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
</code></pre></div><p>Host A (that&rsquo;s where KubeDNS&rsquo; <code>10.24.9.14</code> is):</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="o">% sudo iptables -A PREROUTING -p icmp -t raw -s 10.24.11.0/24 -j TRACE
</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">d</span> <span class="m">10.24</span><span class="m">.11</span><span class="m">.0</span><span class="o">/</span><span class="m">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
% <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
<span class="n">[</span> <span class="m">5528.648942</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">raw</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">5</span>     <span class="n">IN</span><span class="o">=</span><span class="n">eth0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5528.668115</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>  <span class="n">IN</span><span class="o">=</span><span class="n">eth0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5528.687502</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>     <span class="n">IN</span><span class="o">=</span><span class="n">eth0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">62</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5528.706928</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>       <span class="n">IN</span><span class="o">=</span><span class="n">eth0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">62</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5528.726471</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>  <span class="n">IN</span><span class="o">=</span><span class="n">eth0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">62</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
<span class="n">[</span> <span class="m">5528.746157</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span> <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.14</span> <span class="n">LEN</span><span class="o">=</span><span class="m">84</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">62</span> <span class="n">ID</span><span class="o">=</span><span class="m">10728</span> <span class="n">DF</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">ICMP</span> <span class="n">TYPE</span><span class="o">=</span><span class="m">8</span> <span class="n">CODE</span><span class="o">=</span><span class="m">0</span> <span class="n">ID</span><span class="o">=</span><span class="m">1</span> <span class="n">SEQ</span><span class="o">=</span><span class="m">1</span>
</code></pre></div><h2 id="lets-try-again-with-udp">Let&rsquo;s try again with udp</h2>
<p>Host B:</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="o">% docker run --rm -it --net=container:$(docker ps | grep POD_traefik | head -1 | cut -f1 -d&#39; &#39;) --privileged praqma/network-multitool nslookup github.com
</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">d</span> <span class="m">10.24</span><span class="m">.11</span><span class="m">.0</span><span class="o">/</span><span class="m">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
<span class="o">% sudo iptables -A PREROUTING -p udp -t raw -s 10.24.11.0/24 -j TRACE
</span><span class="o">%</span> <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
<span class="n">[</span> <span class="m">6160.660913</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">raw</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">7</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.681727</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>               <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.702962</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">PREROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.723562</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                 <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.744284</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SVC</span><span class="o">-</span><span class="n">TCOU7JCQXEZGVUNU</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.766008</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SEP</span><span class="o">-</span><span class="n">FNEHYJGPMQEV2RPP</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>     <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span>     <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.27</span><span class="m">.240</span><span class="m">.10</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">64</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.788020</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>                  <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.809069</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.829669</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">4</span>             <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.850869</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.871663</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">SERVICES</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">1</span>            <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.893472</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">3</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.914059</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">USER</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.935373</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">4</span>                    <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.956083</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">DOCKER</span><span class="o">-</span><span class="n">ISOLATION</span><span class="o">-</span><span class="n">STAGE</span><span class="m">-1</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">2</span> <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.978371</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">filter</span><span class="o">:</span><span class="n">FORWARD</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">10</span>                   <span class="n">IN</span><span class="o">=</span><span class="n">cbr0</span> <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6160.999283</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">mangle</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">1</span>              <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6161.016840</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">1</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6161.033296</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">KUBE</span><span class="o">-</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">return</span><span class="o">:</span><span class="m">2</span>            <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6161.050267</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                   <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6161.066717</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">IP</span><span class="o">-</span><span class="n">MASQ</span><span class="o">:</span><span class="n">rule</span><span class="o">:</span><span class="m">2</span>                       <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
<span class="n">[</span> <span class="m">6161.083318</span><span class="n">]</span> <span class="n">TRACE</span><span class="o">:</span> <span class="n">nat</span><span class="o">:</span><span class="n">POSTROUTING</span><span class="o">:</span><span class="n">policy</span><span class="o">:</span><span class="m">4</span>                 <span class="n">IN</span><span class="o">=</span>     <span class="n">OUT</span><span class="o">=</span><span class="n">eth0</span> <span class="n">PHYSIN</span><span class="o">=</span><span class="n">veth98b9f376</span> <span class="n">SRC</span><span class="o">=</span><span class="m">10.24</span><span class="m">.11</span><span class="m">.7</span> <span class="n">DST</span><span class="o">=</span><span class="m">10.24</span><span class="m">.9</span><span class="m">.25</span> <span class="n">LEN</span><span class="o">=</span><span class="m">82</span> <span class="n">TOS</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">PREC</span><span class="o">=</span><span class="mh">0x00</span> <span class="n">TTL</span><span class="o">=</span><span class="m">63</span> <span class="n">ID</span><span class="o">=</span><span class="m">18335</span> <span class="n">PROTO</span><span class="o">=</span><span class="n">UDP</span> <span class="n">SPT</span><span class="o">=</span><span class="m">57262</span> <span class="n">DPT</span><span class="o">=</span><span class="m">53</span> <span class="n">LEN</span><span class="o">=</span><span class="m">62</span>
</code></pre></div><p>Host A:</p>
<div class="highlight"><pre class="chroma"><code class="language-s" data-lang="s"><span class="o">% sudo iptables -A PREROUTING -p udp -t raw -d 10.24.11.0/24 -j TRACE
</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">t</span> <span class="n">raw</span> <span class="o">-</span><span class="n">s</span> <span class="m">10.24</span><span class="m">.11</span><span class="m">.0</span><span class="o">/</span><span class="m">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">TRACE</span>
% <span class="n">dmesg</span> <span class="o">-</span><span class="n">w</span>
<span class="c1"># Nothing!</span>
</code></pre></div><h2 id="communication-between-two-pods-across-nodes">Communication between two pods across nodes</h2>
<p>Host A (10.24.9.26):</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-host-a --overrides<span class="o">=</span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;spec&#34;:{&#34;affinity&#34;:{&#34;nodeAffinity&#34;:{&#34;requiredDuringSchedulingIgnoredDuringExecution&#34;:{&#34;nodeSelectorTerms&#34;:[{&#34;matchFields&#34;:[{&#34;key&#34;:&#34;metadata.name&#34;,&#34;operator&#34;:&#34;In&#34;,&#34;values&#34;:[&#34;gke-august-period-234610-worker-96e2b32f-6k31&#34;]}]}]}}}}}&#39;</span> --rm -i --tty --image nicolaka/netshoot
% nc -v 10.24.11.21 <span class="m">80</span>
Connection to 10.24.11.21 <span class="m">80</span> port <span class="o">[</span>tcp/http<span class="o">]</span> succeeded!
</code></pre></div><p>Host B (10.24.11.21):</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% kubectl run --generator<span class="o">=</span>run-pod/v1 tmp-host-b --overrides<span class="o">=</span><span class="s1">&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;spec&#34;:{&#34;affinity&#34;:{&#34;nodeAffinity&#34;:{&#34;requiredDuringSchedulingIgnoredDuringExecution&#34;:{&#34;nodeSelectorTerms&#34;:[{&#34;matchFields&#34;:[{&#34;key&#34;:&#34;metadata.name&#34;,&#34;operator&#34;:&#34;In&#34;,&#34;values&#34;:[&#34;gke-august-period-234610-worker-micro-2a7d2fc5-f85j&#34;]}]}]}}}}}&#39;</span> --rm -i --tty --image nicolaka/netshoot
% nc -v -l <span class="m">80</span>
Listening on <span class="o">[</span>0.0.0.0<span class="o">]</span> <span class="o">(</span>family 0, port 80<span class="o">)</span>
Connection from 10.24.9.26 <span class="m">38274</span> received!
</code></pre></div><p>Now, using udp:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% nc -v -u 10.24.11.21 <span class="m">80</span>
Connection to 10.24.11.21 <span class="m">80</span> port <span class="o">[</span>udp/http<span class="o">]</span> succeeded!
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% tcpdump <span class="p">&amp;</span> nc -u -l <span class="m">80</span>
<span class="o">[</span>1<span class="o">]</span> <span class="m">32</span>
tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
<span class="c1"># Nothing</span>
</code></pre></div><p>Definitely something wrong with anything else than 80/tcp!</p>
<h2 id="omg-it-was-a-missing-firewall-rule">OMG it was a missing firewall rule</h2>
<p>I realised that only 80/tcp, 443/tcp and icmp packets would get routed.
It&rsquo;s surprisingly very specific: what if the VPC firewall rules were off.
Maybe these 80/tcp and 443/tcp are correspond to the rule
&ldquo;akrobateo-fw-traefik&rdquo; I had added when I wanted to load-balance traffic
direclty from the cluster (as opposed as external load balancing).</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% gcloud compute firewall-rules list
NAME                                 NETWORK  DIRECTION  PRIORITY  ALLOW                         DENY  DISABLED
akrobateo-fw-traefik                 default  INGRESS    <span class="m">1000</span>      tcp:80,tcp:443                      False
default-allow-icmp                   default  INGRESS    <span class="m">65534</span>     icmp                                False
default-allow-internal               default  INGRESS    <span class="m">65534</span>     tcp:0-65535,udp:0-65535,icmp        False
default-allow-rdp                    default  INGRESS    <span class="m">65534</span>     tcp:3389                            False
default-allow-ssh                    default  INGRESS    <span class="m">65534</span>     tcp:22                              False
</code></pre></div><p>No rule for traffic in <code>10.24.0.0/14</code>! This CIDR is the subnet used for
distributing CIDRs to each node. So I added a new rule &ldquo;all&rdquo;; here is the
new list of rules:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% gcloud compute firewall-rules list
NAME                                 NETWORK  DIRECTION  PRIORITY  ALLOW                         DENY  DISABLED
akrobateo-fw-traefik                 default  INGRESS    <span class="m">1000</span>      tcp:80,tcp:443                      False
default-allow-icmp                   default  INGRESS    <span class="m">65534</span>     icmp                                False
default-allow-internal               default  INGRESS    <span class="m">65534</span>     tcp:0-65535,udp:0-65535,icmp        False
default-allow-rdp                    default  INGRESS    <span class="m">65534</span>     tcp:3389                            False
default-allow-ssh                    default  INGRESS    <span class="m">65534</span>     tcp:22                              False
gke-august-period-234610-all         default  INGRESS    <span class="m">1000</span>      udp,icmp,esp,ah,sctp,tcp            False
</code></pre></div><p>Now, let&rsquo;s test again:</p>
<p>Pod &ldquo;tmp-host-b&rdquo; (10.24.11.26) on Host B:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% nc -v -u 10.24.9.27 <span class="m">8888</span>
<span class="c1"># Exits with 0 and no output</span>
</code></pre></div><p>Pod &ldquo;tmp-host-a&rdquo; (10.24.9.27) on Host A:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">% tcpdump
tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
21:54:39.787779 IP 10.24.11.26.40760 &gt; tmp-host-a.8888: UDP, length <span class="m">1</span>
21:54:39.787802 IP tmp-host-a &gt; 10.24.11.26: ICMP tmp-host-a udp port <span class="m">8888</span> unreachable, length <span class="m">37</span>
21:54:39.787805 IP 10.24.11.26.40760 &gt; tmp-host-a.8888: UDP, length <span class="m">1</span>
21:54:39.787808 IP tmp-host-a &gt; 10.24.11.26: ICMP tmp-host-a udp port <span class="m">8888</span> unreachable, length <span class="m">37</span>
</code></pre></div><p>Yay!</p>

</div>
<a href="https://github.com/maelvls/maelvls.github.io/edit/source/content/notes/kubectl.md">ð Edit this page and propose a change!</a>
<div class="tags">









</div>

<script
  src="https://utteranc.es/client.js"
  repo="maelvls/maelvls.github.io"
  issue-term="pathname"
  label="ð¬"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</div>

</main><footer>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-88710120-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</footer>
</body>
</html>
