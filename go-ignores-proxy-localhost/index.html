<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.64.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keywords content="go,proxyman"><meta name=description content="At some point, the Go team chose to disable the proxy for requests coming
from localhost or 127.0.0.1. This is annoying when debugging services
locally."><meta property="og:title" content="What to do when Go ignores HTTP_PROXY for 127.0.0.1"><meta property="og:description" content="At some point, the Go team chose to disable the proxy for requests coming
from localhost or 127.0.0.1. This is annoying when debugging services
locally."><meta property="og:type" content="article"><meta property="og:url" content="https://maelvls.dev/go-ignores-proxy-localhost/"><meta property="og:image" content="https://maelvls.dev/go-ignores-proxy-localhost/cover-go-proxy-ignored.png"><meta property="article:published_time" content="2020-01-06T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-06T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maelvls.dev/go-ignores-proxy-localhost/cover-go-proxy-ignored.png"><meta name=twitter:title content="What to do when Go ignores HTTP_PROXY for 127.0.0.1"><meta name=twitter:description content="At some point, the Go team chose to disable the proxy for requests coming
from localhost or 127.0.0.1. This is annoying when debugging services
locally."><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/main.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/all.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/maelvls.css><title>What to do when Go ignores HTTP_PROXY for 127.0.0.1 | maelvls dev blog</title></head><body><header><div id=avatar><a href=https://maelvls.dev/><img src=/img/mael.jpg alt="maelvls dev blog"></a></div><div id=titletext><h2 id=title><a href=https://maelvls.dev/>maelvls dev blog</a></h2></div><div id=title-description><p id=subtitle>Systems software engineer. I write mostly about Kubernetes and Go. <a href=/about>About</a></p><div id=social><nav><ul><li><a href=https://github.com/maelvls><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://twitter.com/maelvls><i title=Twitter class="icons fab fa-twitter"></i></a></li></ul></nav></div></div><div id=mainmenu></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>06</span>
<span class=rest>Jan 2020</span></div></div><div class=matter><h1 class=title>What to do when Go ignores HTTP_PROXY for 127.0.0.1</h1></div></div><div class=markdown><p>I use <a href=https://proxyman.io>Proxyman</a> for inspecting the HTTP and HTTPS
traffic coming from applications. For example, you may want to know which
API calls are made by <code>docker</code> when running <code>docker search</code>. What I would
do is</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>HTTPS_PROXY</span><span class=o>=</span>http://localhost:9090 docker search ubuntu
</code></pre></div><p>Since Proxyman acts like a proxy listening on 0.0.0.0:9090, I can see and
replay all the HTTP calls, similarly to what you would do with the Chrome
DevTools.</p><p><img src=proxyman.png alt="Screenshot with macOS&rsquo; Proxyman for a local Openstack instance"></p><p>Note that HTTPS is a bit tricky and requires an additional step on macOS
(settings > Proxyman CA > Generate new) but works flawlessly with any Go
binary since Go supports <code>HTTPS_PROXY</code> by default. For Python, it becomes a
bit trickier often requires the app to have a flag like <code>--cacert</code>.</p><p>But by default, Go [ignores <code>HTTPS_PROXY</code>] for <code>localhost</code> and <code>127.0.0.1</code> hosts (see <a href=https://godoc.org/golang.org/x/net/http/httpproxy#Config.ProxyFunc>ProxyFunc</a> and <a href=https://github.com/golang/net/blob/c0dbc17a35534bf2e581d7a942408dc936316da4/http/httpproxy/proxy.go#L172-L191>useProxy</a>):</p><blockquote><p>As a special case, if req.URL.Host is &ldquo;localhost&rdquo; (with or without a port
number), then a nil URL and nil error will be returned.</p></blockquote><p>Note that the documentation forgets to mention that <code>127.0.0.1</code> (and
related) are also ignored. That&rsquo;s a bummer since using a proxy may be the
only way to debug a CLI or an application that makes network calls without
logging properly.</p><p>Two solutions: either you have access (and are willing to) hack the source
code in order to force Go to use the proxy with <code>localhost</code> anyway, or you
can hack your <code>/etc/hosts</code> and use a different host.</p><h2 id=solution-1-hack-the-proxy-setup-by-tweaking-httptransport>Solution 1: hack the proxy setup by tweaking <code>http.Transport</code></h2><p>You need to have access to the place where the <code>http.Client</code> is set. Imagine that you are working on something that uses the Openstack API. You would have something like:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;os&#34;</span>

	<span class=s>&#34;github.com/gophercloud/gophercloud&#34;</span>
	<span class=s>&#34;github.com/gophercloud/gophercloud/openstack&#34;</span>
	<span class=s>&#34;github.com/gophercloud/gophercloud/openstack/compute/v2/servers&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>pr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=s>&#34;http://localhost/identity/v3&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;could not create an openstack client&#34;</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>err</span> <span class=p>=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>Authenticate</span><span class=p>(</span><span class=nx>pr</span><span class=p>,</span> <span class=nx>gophercloud</span><span class=p>.</span><span class=nx>AuthOptions</span><span class=p>{</span>
		<span class=nx>IdentityEndpoint</span><span class=p>:</span> <span class=s>&#34;http://localhost/identity/v3&#34;</span><span class=p>,</span>
		<span class=nx>DomainName</span><span class=p>:</span>       <span class=s>&#34;Default&#34;</span><span class=p>,</span>
		<span class=nx>Username</span><span class=p>:</span>         <span class=s>&#34;admin&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span>         <span class=s>&#34;secret&#34;</span><span class=p>,</span>
		<span class=nx>TenantName</span><span class=p>:</span>       <span class=s>&#34;admin&#34;</span><span class=p>,</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;auth failed&#34;</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>compute</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>NewComputeV2</span><span class=p>(</span><span class=nx>pr</span><span class=p>,</span> <span class=nx>gophercloud</span><span class=p>.</span><span class=nx>EndpointOpts</span><span class=p>{</span><span class=nx>Region</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>}</span><span class=p>)</span>
	<span class=nx>srvs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>servers</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=nx>compute</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span><span class=p>.</span><span class=nf>AllPages</span><span class=p>(</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;servers:\n%v\n&#34;</span><span class=p>,</span> <span class=nx>srvs</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>We must be able to swap the <code>http.Transport</code> used. The <a href=https://golang.org/src/net/http/transport.go#L42><code>http.DefaultTransport</code></a> uses <code>ProxyFromEnvironment</code>:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=c1>// DefaultTransport is the default implementation of Transport and is
</span><span class=c1></span><span class=c1>// used by DefaultClient. It establishes network connections as needed
</span><span class=c1></span><span class=c1>// and caches them for reuse by subsequent calls. It uses HTTP proxies
</span><span class=c1></span><span class=c1>// as directed by the $HTTP_PROXY and $NO_PROXY (or $http_proxy and
</span><span class=c1></span><span class=c1>// $no_proxy) environment variables.
</span><span class=c1></span><span class=kd>var</span> <span class=nx>DefaultTransport</span> <span class=nx>RoundTripper</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>Transport</span><span class=p>{</span>
	<span class=nx>Proxy</span><span class=p>:</span> <span class=nx>ProxyFromEnvironment</span><span class=p>,</span>
	<span class=nx>DialContext</span><span class=p>:</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>net</span><span class=p>.</span><span class=nx>Dialer</span><span class=p>{</span>
		<span class=nx>Timeout</span><span class=p>:</span>   <span class=mi>30</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
		<span class=nx>KeepAlive</span><span class=p>:</span> <span class=mi>30</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
		<span class=nx>DualStack</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
	<span class=p>}</span><span class=p>)</span><span class=p>.</span><span class=nx>DialContext</span><span class=p>,</span>
	<span class=nx>ForceAttemptHTTP2</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
	<span class=nx>MaxIdleConns</span><span class=p>:</span>          <span class=mi>100</span><span class=p>,</span>
	<span class=nx>IdleConnTimeout</span><span class=p>:</span>       <span class=mi>90</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
	<span class=nx>TLSHandshakeTimeout</span><span class=p>:</span>   <span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
	<span class=nx>ExpectContinueTimeout</span><span class=p>:</span> <span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
<span class=p>}</span>
</code></pre></div><p>Let&rsquo;s change <code>ProxyFromEnvironment</code> with something of our own:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=nx>Proxy</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;http://127.0.0.1:9090&#34;</span><span class=p>)</span>
<span class=p>}</span><span class=p>,</span>
</code></pre></div><p>Now, the code looks like this:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;net&#34;</span>
	<span class=s>&#34;net/http&#34;</span>
	<span class=s>&#34;net/url&#34;</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/gophercloud/gophercloud&#34;</span>
	<span class=s>&#34;github.com/gophercloud/gophercloud/openstack&#34;</span>
	<span class=s>&#34;github.com/gophercloud/gophercloud/openstack/compute/v2/servers&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>pr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=s>&#34;http://localhost/identity/v3&#34;</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;could not create an openstack client&#34;</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=nx>pr</span><span class=p>.</span><span class=nx>HTTPClient</span><span class=p>.</span><span class=nx>Transport</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Transport</span><span class=p>{</span>
		<span class=nx>Proxy</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>url</span><span class=p>.</span><span class=nx>URL</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;http://127.0.0.1:9090&#34;</span><span class=p>)</span>
		<span class=p>}</span><span class=p>,</span>
		<span class=nx>DialContext</span><span class=p>:</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>net</span><span class=p>.</span><span class=nx>Dialer</span><span class=p>{</span>
			<span class=nx>Timeout</span><span class=p>:</span>   <span class=mi>30</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
			<span class=nx>KeepAlive</span><span class=p>:</span> <span class=mi>30</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
			<span class=nx>DualStack</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
		<span class=p>}</span><span class=p>)</span><span class=p>.</span><span class=nx>DialContext</span><span class=p>,</span>
		<span class=nx>ForceAttemptHTTP2</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
		<span class=nx>MaxIdleConns</span><span class=p>:</span>          <span class=mi>100</span><span class=p>,</span>
		<span class=nx>IdleConnTimeout</span><span class=p>:</span>       <span class=mi>90</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
		<span class=nx>TLSHandshakeTimeout</span><span class=p>:</span>   <span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
		<span class=nx>ExpectContinueTimeout</span><span class=p>:</span> <span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=nx>err</span> <span class=p>=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>Authenticate</span><span class=p>(</span><span class=nx>pr</span><span class=p>,</span> <span class=nx>gophercloud</span><span class=p>.</span><span class=nx>AuthOptions</span><span class=p>{</span>
		<span class=nx>IdentityEndpoint</span><span class=p>:</span> <span class=s>&#34;http://localhost/identity/v3&#34;</span><span class=p>,</span>
		<span class=nx>DomainName</span><span class=p>:</span>       <span class=s>&#34;Default&#34;</span><span class=p>,</span>
		<span class=nx>Username</span><span class=p>:</span>         <span class=s>&#34;admin&#34;</span><span class=p>,</span>
		<span class=nx>Password</span><span class=p>:</span>         <span class=s>&#34;secret&#34;</span><span class=p>,</span>
		<span class=nx>TenantName</span><span class=p>:</span>       <span class=s>&#34;admin&#34;</span><span class=p>,</span>
	<span class=p>}</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;auth failed&#34;</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>compute</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>openstack</span><span class=p>.</span><span class=nf>NewComputeV2</span><span class=p>(</span><span class=nx>pr</span><span class=p>,</span> <span class=nx>gophercloud</span><span class=p>.</span><span class=nx>EndpointOpts</span><span class=p>{</span><span class=nx>Region</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>}</span><span class=p>)</span>
	<span class=nx>srvs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>servers</span><span class=p>.</span><span class=nf>List</span><span class=p>(</span><span class=nx>compute</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span><span class=p>.</span><span class=nf>AllPages</span><span class=p>(</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;servers:\n%v\n&#34;</span><span class=p>,</span> <span class=nx>srvs</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Now, all traffic including calls to <code>Host: localhost</code> or <code>Host: 127.0.0.1</code>
will be properly proxied to <code>localhost:9090</code>.</p><h2 id=solution-2-use-a-different-host-name>Solution 2: use a different host name</h2><p>In your <code>/etc/hosts</code>, add the line such as <code>local 127.0.0.1</code>. Now, you can
use the host <code>local</code> instead of <code>localhost</code>, which means Go will proxy your
requests properly.</p><script src=https://utteranc.es/client.js repo=maelvls/maelvls.github.io issue-term=pathname label=ðŸ’¬ theme=github-light crossorigin=anonymous async></script></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/go/>go</a>
<a href=/tags/proxyman/>proxyman</a></div><div class=clearit></div></div></div></div></main><footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-88710120-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>