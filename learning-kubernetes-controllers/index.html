<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.64.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=keywords content="kubernetes,controllers"><meta name=description content="Kubernetes' extensibility is probably its biggest strength. Controllers and
CRDs are all over the place. But finding the right information to begin
writing a controller isn't easy due to the sheer amount of tribal knowledge
scattered everywhere. Here are some links to help you start."><meta property="og:title" content="Learning Kubernetes Controllers"><meta property="og:description" content="Kubernetes' extensibility is probably its biggest strength. Controllers and
CRDs are all over the place. But finding the right information to begin
writing a controller isn't easy due to the sheer amount of tribal knowledge
scattered everywhere. Here are some links to help you start."><meta property="og:type" content="article"><meta property="og:url" content="https://maelvls.dev/learning-kubernetes-controllers/"><meta property="og:image" content="https://maelvls.dev/learning-kubernetes-controllers/cover-learning-kubernetes-controllers.png"><meta property="article:published_time" content="2020-04-22T11:58:26+02:00"><meta property="article:modified_time" content="2020-04-22T11:58:26+02:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maelvls.dev/learning-kubernetes-controllers/cover-learning-kubernetes-controllers.png"><meta name=twitter:title content="Learning Kubernetes Controllers"><meta name=twitter:description content="Kubernetes' extensibility is probably its biggest strength. Controllers and
CRDs are all over the place. But finding the right information to begin
writing a controller isn't easy due to the sheer amount of tribal knowledge
scattered everywhere. Here are some links to help you start."><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/main.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/all.css><link rel=stylesheet type=text/css media=screen href=https://maelvls.dev/css/maelvls.css><title>Learning Kubernetes Controllers | maelvls dev blog</title></head><body><header><div id=avatar><a href=https://maelvls.dev/><img src=/img/mael.jpg alt="maelvls dev blog"></a></div><div id=titletext><h2 id=title><a href=https://maelvls.dev/>maelvls dev blog</a></h2></div><div id=title-description><p id=subtitle>Systems software engineer. I write mostly about Kubernetes and Go. <a href=/about>About</a></p><div id=social><nav><ul><li><a href=https://github.com/maelvls><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://twitter.com/maelvls><i title=Twitter class="icons fab fa-twitter"></i></a></li></ul></nav></div></div><div id=mainmenu></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>22</span>
<span class=rest>Apr 2020</span></div></div><div class=matter><h1 class=title>Learning Kubernetes Controllers</h1></div></div><div class=markdown><p>Kubernetes&rsquo; extensibility is probably its biggest strength. Controllers and
CRDs are all over the place. But finding the right information to begin
writing a controller isn&rsquo;t easy due to the sheer amount of tribal knowledge
scattered everywhere. This post intends to help you start with controllers.</p><hr><p>Let us begin with some terminology:</p><ul><li>By &ldquo;controller&rdquo; (singular noun), I mean one single loop that watches some
objects. I often call this loop &ldquo;controller loop&rdquo; or &ldquo;sync loop&rdquo; or even
&ldquo;reconcile loop&rdquo;.</li><li>By &ldquo;controllers&rdquo; (plural), I mean one binary that runs multiple sync
loops.</li><li>A CRD (custom resource definition) is a simple YAML manifest that
describes a custom object. After applying it to a Kubernetes cluster, it
will start accepting manifests of this custom kind.</li><li>&ldquo;CRD&rdquo; is just a schema and doesn&rsquo;t carry any logic (except for the basic
validation the apiserver does). The actual logic happens in controllers.</li><li>Many people also use the term &ldquo;operator&rdquo; to mean &ldquo;controllers&rdquo;. I do not
make a distinction between an operator (e.g., the <a href=https://github.com/elastic/cloud-on-k8s>elastic
operator</a>) or controllers.</li></ul><hr><p>Here are the links that I would give to anyone interested in writing their
own controller:</p><ul><li><p><a href=https://book.kubebuilder.io/quick-start.html>Kubebuilder book</a>Â is a
nice starting point. Kubebuilder uses code generation a lot and that&rsquo;s
what most controllers use nowadays (Rancher uses a somehow forked version
of controller-runtime and controller-tools,
<a href=https://github.com/rancher/wrangler>Wrangler</a>, that also generates code
but with their own &ldquo;style&rdquo; â€“ for example, simple flat interfaces instead
of <a href=https://github.com/kubernetes/client-go>client-go</a>&lsquo;s deeply nested
interfaces that don&rsquo;t feel like Go).</p></li><li><p>The <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>Kubernetes API
conventions</a>
is an amazing document. It summarizes a lot of the &ldquo;tribal knowledge&rdquo;
around naming and how sync loops are conceived and what they mean by
&ldquo;level-based behaviour&rdquo;.</p></li><li><p>Github search &ldquo;<a href="https://github.com/search?q=language%3Ayaml+language%3Ago+kubernetes+controllers">language:yaml language:go kubernetes controllers</a>", tons of nice examples of controllers</p></li><li><p><a href=https://github.com/jetstack/cert-manager>cert-manager</a>&lsquo;s codebase is a nice controller to take a look at</p></li><li><p>ClusterAPIÂ <a href=https://github.com/kubernetes-sigs/cluster-api/blob/master/docs/proposals/20190610-machine-states-preboot-bootstrapping.md>proposals</a>Â and codebase (<a href=https://github.com/kubernetes-sigs/cluster-api>capi</a>,Â <a href=https://github.com/kubernetes-sigs/cluster-api-provider-aws>capa</a>) andÂ  (we took a lot of inspiration from what they do)</p></li><li><p>The ClusterAPIÂ <a href=https://docs.google.com/document/d/1fQNlqsDkvEggWFi51GVxOglL2P1Bvo2JhZlMhm2d-Co/edit#>Meeting
notes</a>Â contains
a ton of useful information on Machine, MachinePool&mldr; (crazy how much I
learned from that).</p></li><li><p>The Kubernetes <code>status</code> field is tricky. You can take a look at
&ldquo;<a href=https://maelvls.dev/kubernetes-conditions/>conditions vs. phases vs.
reasons</a>".</p></li><li><p>The <a href=https://github.com/kubernetes/kubernetes>Kubernetes codebase</a>
itself is also a very nice read. It might feel overwhelming at first; I
invite you to take a look at a few of the following sync loops contained
in the <code>kube-controller-manager</code>, <code>kube-scheduler</code> and <code>kubelet</code>. Since
each sync loop reads or updates different objects, I also detail which
objects are updated or created by each sync loop:</p><table><thead><tr><th>binary</th><th>sync loop = component</th><th>reads</th><th>creates</th><th>updates</th></tr></thead><tbody><tr><td>kube-controller-manager</td><td><a href=https://github.com/kubernetes/kubernetes/blob/5bac42bf/pkg/controller/deployment/deployment_controller.go#L560-L649><code>syncDeployment</code></a></td><td>Pod</td><td>ReplicaSet</td><td>Deployment</td></tr><tr><td>kube-controller-manager</td><td><a href=https://github.com/kubernetes/kubernetes/blob/5bac42bf/pkg/controller/replicaset/replica_set.go#L653-L721><code>syncReplicaSet</code></a></td><td></td><td>Pod</td><td></td></tr><tr><td>kubelet</td><td><a href=https://github.com/kubernetes/kubernetes/blob/5bac42bf/pkg/kubelet/status/status_manager.go#L514-L567><code>syncPod</code></a></td><td></td><td></td><td>Pod</td></tr><tr><td>kube-scheduler</td><td><a href=https://github.com/kubernetes/kubernetes/blob/5bac42bf/pkg/scheduler/scheduler.go#L589-L762><code>scheduleOne</code></a></td><td></td><td></td><td>Pod</td></tr><tr><td>kubelet</td><td><a href=https://github.com/kubernetes/kubernetes/blob/5bac42bff9bfb9dfe0f2ea40f1c80cac47fc12b2/pkg/kubelet/kubelet_node_status.go#L374-L391><code>syncNodeStatus</code></a></td><td></td><td></td><td>Node</td></tr></tbody></table></li><li><p><a href=https://changelog.com/gotime/105>Gotime 105</a> &ldquo;Kubernetes and Cloud
Native&rdquo; with Joe Beda (initiator of Kubernetes) and Kris Nova is very
interesting and tells us more about the genesis of the project, which
things like why is Kubernetes written in Go and why client-go feels like
Java.</p></li><li><p><a href=operator-sdk>https://github.com/operator-framework/operator-sdk</a>
(RedHat) is a package that aims at helping dealing with the whole
scafollding when writing a sync loop. It relies on
<a href=https://github.com/kubernetes-sigs/controller-runtime>controller-runtime</a>.
I don&rsquo;t use either of them but taking a look at these projects helps
getting more understanding about the challenges (read: boilerplate) that
comes when writing controllers. I personally write all the
controller-related boilerplate myself (creating the queue, setting event
handlers, running the loop itself&mldr;).</p></li></ul><p>And a final note: CRDs are not necessary for writing a controller! You can
write a tiny controller that watches the &ldquo;standard&rdquo; Kubernetes objects.
That&rsquo;s exactly what ingress controllers do: they watch for Service objects.</p><script src=https://utteranc.es/client.js repo=maelvls/maelvls.github.io issue-term=pathname label=ðŸ’¬ theme=github-light crossorigin=anonymous async></script></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/controllers/>controllers</a>
<a href=/tags/kubernetes/>kubernetes</a></div><div class=clearit></div></div></div></div></main><footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-88710120-3','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>